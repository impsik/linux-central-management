<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <title>Fleet Management</title>
  <script src="/assets/fleet-theme-bootstrap.js?v=__ASSET_VERSION__"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm/css/xterm.css" />
  <script src="https://cdn.jsdelivr.net/npm/xterm/lib/xterm.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit/lib/xterm-addon-fit.js"></script>
  <script src="/assets/fleet-phase3.js?v=__ASSET_VERSION__"></script>
  <script src="/assets/fleet-phase3-mfa.js?v=__ASSET_VERSION__"></script>
  <script src="/assets/fleet-phase3-auth-ui.js?v=__ASSET_VERSION__"></script>
  <script src="/assets/fleet-phase3-core-ui.js?v=__ASSET_VERSION__"></script>
  <script src="/assets/fleet-phase3-auth-state.js?v=__ASSET_VERSION__"></script>
  <script src="/assets/fleet-phase3-modals.js?v=__ASSET_VERSION__"></script>
  <script src="/assets/fleet-phase3-host-list.js?v=__ASSET_VERSION__"></script>
  <script src="/assets/fleet-phase3-host-filters-ui.js?v=__ASSET_VERSION__"></script>
  <script src="/assets/fleet-phase3-host-filters-vuln.js?v=__ASSET_VERSION__"></script>
  <script src="/assets/fleet-phase3-host-filters.js?v=__ASSET_VERSION__"></script>
  <script src="/assets/fleet-phase3-ansible.js?v=__ASSET_VERSION__"></script>
  <script src="/assets/fleet-phase3-host-workflows.js?v=__ASSET_VERSION__"></script>
  <script src="/assets/fleet-phase3-ssh-ui.js?v=__ASSET_VERSION__"></script>
  <script src="/assets/fleet-phase3-metrics.js?v=__ASSET_VERSION__"></script>
  <script src="/assets/fleet-phase3-overview.js?v=__ASSET_VERSION__"></script>
  <script src="/assets/fleet-phase3-packages.js?v=__ASSET_VERSION__"></script>
  <script src="/assets/fleet-phase3-host-actions.js?v=__ASSET_VERSION__"></script>
  <link rel="stylesheet" href="/assets/index-MnFIflNy.css?v=__ASSET_VERSION__" />
  <link rel="stylesheet" href="/assets/fleet-ui.css?v=__ASSET_VERSION__" />
</head>

<body>
  <div class="header">
    <div class="header-title">
      <h1 id="app-title">Fleet Management</h1>
    </div>
    <div class="header-actions">
      <div class="header-user">
        <div class="header-subtitle" id="current-user">Signed in</div>
        <div class="settings-menu" id="settings-menu-wrap">
          <button class="icon-btn" id="theme-toggle" type="button" title="Toggle theme" aria-label="Toggle theme">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path
                d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm0-16a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0V3a1 1 0 0 1 1-1zm0 18a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0v-1a1 1 0 0 1 1-1zM4.22 5.64a1 1 0 0 1 1.41 0l.7.7A1 1 0 1 1 4.92 7.75l-.7-.7a1 1 0 0 1 0-1.41zm12.45 12.45a1 1 0 0 1 1.41 0l.7.7a1 1 0 1 1-1.41 1.41l-.7-.7a1 1 0 0 1 0-1.41zM2 12a1 1 0 0 1 1-1h1a1 1 0 1 1 0 2H3a1 1 0 0 1-1-1zm18 0a1 1 0 0 1 1-1h1a1 1 0 1 1 0 2h-1a1 1 0 0 1-1-1zM4.22 18.36a1 1 0 0 1 0-1.41l.7-.7a1 1 0 1 1 1.41 1.41l-.7.7a1 1 0 0 1-1.41 0zM16.67 5.91a1 1 0 0 1 0-1.41l.7-.7a1 1 0 1 1 1.41 1.41l-.7.7a1 1 0 0 1-1.41 0z" />
            </svg>
          </button>
          <button class="icon-btn" id="settings-btn" type="button" aria-haspopup="true" aria-expanded="false"
            aria-controls="settings-dropdown" title="Settings">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path
                d="M19.14 12.94c.04-.3.06-.61.06-.94s-.02-.64-.06-.94l2.03-1.58a.5.5 0 0 0 .12-.64l-1.92-3.32a.5.5 0 0 0-.6-.22l-2.39.96a7.47 7.47 0 0 0-1.63-.94l-.36-2.54A.5.5 0 0 0 13.9 1h-3.8a.5.5 0 0 0-.49.41l-.36 2.54a7.47 7.47 0 0 0-1.63.94l-2.39-.96a.5.5 0 0 0-.6.22L2.71 7.97a.5.5 0 0 0 .12.64l2.03 1.58c-.04.3-.06.62-.06.94s.02.64.06.94L2.83 13.65a.5.5 0 0 0-.12.64l1.92 3.32a.5.5 0 0 0 .6.22l2.39-.96c.5.39 1.05.72 1.63.94l.36 2.54a.5.5 0 0 0 .49.41h3.8a.5.5 0 0 0 .49-.41l.36-2.54c.58-.22 1.13-.55 1.63-.94l2.39.96a.5.5 0 0 0 .6-.22l1.92-3.32a.5.5 0 0 0-.12-.64l-2.03-1.58zM12 15.5A3.5 3.5 0 1 1 12 8a3.5 3.5 0 0 1 0 7.5z" />
            </svg>
          </button>
          <div class="settings-dropdown" id="settings-dropdown" role="menu">
            <button class="settings-item" id="admin-menu-item" type="button" role="menuitem">Admin</button>
            <button class="settings-item" id="logout-btn" type="button" role="menuitem">Logout</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="sidebar" aria-hidden="true" style="display:none;">
      <div id="hosts" style="display:none;"></div>
    </div>

    <div class="main-content">
      <div class="host-actions" id="fleet-actions" style="display: flex; gap: 0.5rem; margin-bottom: 0.35rem;">
        <button class="btn" id="nav-overview" type="button">Overview <span id="notifications-badge" style="display:none;margin-left:6px;color:#ef4444;font-weight:900;">•</span><span id="approvals-badge" title="Pending high-risk approvals" style="display:none;margin-left:6px;color:#f59e0b;font-weight:900;">⚠</span></button>
        <button class="btn" id="nav-hosts" type="button">Hosts</button>
        <button class="btn" id="nav-cronjobs" type="button">Cronjobs</button>
        <button class="btn" id="nav-sshkeys" type="button">SSH Keys <span id="sshkeys-approval-indicator" title="Pending approvals" style="display:none;color:#ef4444;font-weight:900;margin-left:6px;">!</span></button>
      </div>

      <div class="host-actions" id="host-actions" style="display: none; padding-top: 0; margin-top: -0.35rem; margin-bottom: 0.75rem;">
        <button class="btn btn-primary host-action-btn" id="host-action-terminal" type="button">Terminal</button>
        <button class="btn btn-primary host-action-btn" id="host-action-users" type="button">Users</button>
        <button class="btn btn-primary host-action-btn" id="host-action-services" type="button">Services</button>
        <button class="btn btn-primary host-action-btn" id="host-action-packages" type="button">Packages</button>
      </div>

      <!-- Server Info / Overview View -->
      <div class="tab-content-custom active" id="server-info-tab">
        <div class="server-info-content">
          <div id="server-info-header" style="display: none;">
            <div class="server-info-title">
              <div>
                <h2 id="server-info-hostname">Server Name</h2>
                <div id="server-info-details" class="server-info-details"></div>
                <div id="server-info-labels" class="label-badges"></div>
              </div>
            </div>

            <div class="metrics-grid">
              <div class="metric-card" id="disk-card" title="Click for df -h details" style="cursor:pointer;">
                <div class="metric-label">Disk Usage</div>
                <div class="metric-value" id="disk-usage">-</div>
                <div class="metric-details" id="disk-details">-</div>
                <div class="metric-bar">
                  <div class="metric-bar-fill" id="disk-bar" style="width: 0%"></div>
                </div>
              </div>

              <div class="metric-card">
                <div class="metric-label">Memory</div>
                <div class="metric-value" id="memory-usage">-</div>
                <div class="metric-details" id="memory-details">-</div>
                <div class="metric-bar">
                  <div class="metric-bar-fill" id="memory-bar" style="width: 0%"></div>
                </div>
              </div>

              <div class="metric-card">
                <div class="metric-label">vCPUs</div>
                <div class="metric-value" id="vcpus">-</div>
                <div class="metric-details">CPU Cores</div>
              </div>

              <div class="metric-card">
                <div class="metric-label">IP Addresses</div>
                <div class="metric-value" id="ip-addresses">-</div>
                <div class="metric-details" id="ip-list"></div>
              </div>
            </div>

            <div class="overview-cards-grid" style="margin:0.5rem 0 1rem;grid-template-columns:minmax(280px,1fr) minmax(380px,1.4fr);">
              <div class="admin-card">
                <div class="admin-card-title">Drift v1</div>
                <div class="admin-card-body">
                  <div id="host-drift-summary" style="color:var(--muted-2);font-size:0.9rem;">Loading…</div>
                  <div id="host-drift-list" style="display:grid;gap:0.35rem;margin-top:0.5rem;"></div>
                </div>
              </div>
              <div class="admin-card">
                <div class="admin-card-title" style="display:flex;align-items:center;justify-content:space-between;gap:0.6rem;flex-wrap:wrap;">
                  <span>Host timeline <span id="host-timeline-count" class="status-muted" style="font-size:0.82rem;font-weight:500;"></span></span>
                  <div style="display:flex;gap:0.35rem;flex-wrap:wrap;">
                    <button class="btn" id="timeline-filter-all" type="button">All</button>
                    <button class="btn" id="timeline-filter-failed" type="button">Failed</button>
                    <button class="btn" id="timeline-filter-security" type="button">Security</button>
                    <button class="btn" id="timeline-filter-package" type="button">Package</button>
                    <button class="btn" id="timeline-filter-service" type="button">Service</button>
                  </div>
                </div>
                <div class="admin-card-body">
                  <div id="host-timeline-list" style="display:grid;gap:0.4rem;min-height:340px;max-height:56vh;overflow:auto;"></div>
                </div>
              </div>
            </div>

            <div class="load-graph-container">
              <div style="display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap;">
                <div class="metric-label" style="margin-bottom:0;">System Load (1 min average)</div>
                <div style="display:flex;align-items:center;gap:0.5rem;">
                  <span style="font-size:0.85rem;color:var(--muted-2);">Timeframe</span>
                  <select id="load-timeframe" class="host-search" style="width:auto;padding:0.35rem 0.5rem;">
                    <option value="300">5m</option>
                    <option value="900">15m</option>
                    <option value="3600" selected>1h</option>
                    <option value="21600">6h</option>
                    <option value="86400">24h</option>
                    <option value="604800">7d</option>
                  </select>
                </div>
              </div>
              <canvas id="load-graph"></canvas>
              <div style="margin-top: 1rem;">
                <div class="metric-label">Top Processes (CPU)</div>
                <div style="overflow-x: auto;">
                  <table class="process-table">
                    <thead>
                      <tr>
                        <th>PID</th>
                        <th>User</th>
                        <th>CPU %</th>
                        <th>MEM %</th>
                        <th>Command</th>
                      </tr>
                    </thead>
                    <tbody id="top-processes-body">
                      <tr>
                        <td colspan="5" style="text-align:center;" class="status-muted">Loading...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <div id="server-info-placeholder" class="empty-state" style="text-align:left;max-width:none;">
            <div style="display:flex;align-items:flex-end;justify-content:space-between;gap:1rem;flex-wrap:wrap;">
              <div>
                <h2 style="margin:0 0 0.25rem 0;">Fleet Overview</h2>
                <div style="color:var(--muted-2);font-size:0.95rem;">Live posture across your fleet. Click any tile to drill
                  down.</div>
              </div>
              <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
                <button class="btn" id="overview-refresh" type="button">Refresh</button>
                <button class="btn btn-primary" id="overview-inventory-now" type="button">Inventory now
                  (visible)</button>
                <button class="btn btn-primary" id="overview-security-campaign" type="button">Security campaign</button>
                <button class="btn" id="overview-dist-upgrade" type="button">Full upgrade (dist-upgrade)</button>
              </div>
            </div>

            <div class="metrics-grid" style="margin-top:0.55rem;">
              <div class="metric-card" id="kpi-hosts-online" style="cursor:pointer;">
                <div class="metric-label">Hosts online</div>
                <div class="metric-value" id="kpi-online">–</div>
                <div class="metric-details" id="kpi-online-details">–</div>
              </div>
              <div class="metric-card" id="kpi-security" style="cursor:pointer;">
                <div class="metric-label">Security updates pending</div>
                <div class="metric-value" id="kpi-sec">–</div>
                <div class="metric-details" id="kpi-sec-details">–</div>
              </div>
              <div class="metric-card" id="kpi-updates" style="cursor:pointer;">
                <div class="metric-label">All updates pending</div>
                <div class="metric-value" id="kpi-upd">–</div>
                <div class="metric-details" id="kpi-upd-details">–</div>
              </div>
              <div class="metric-card" id="kpi-failures" style="cursor:pointer;">
                <div class="metric-label">Failed runs (24h)</div>
                <div class="metric-value" id="kpi-fail">–</div>
                <div class="metric-details" id="kpi-fail-details">Jobs / campaigns</div>
              </div>
            </div>

            <div class="overview-cards-grid" style="margin-top:0.55rem;">
              <div class="admin-card" style="margin:0;height:100%;">
                <div class="admin-card-title">Attention required</div>
                <div class="admin-card-body">
                  <div id="overview-attention" class="status-muted">Loading…</div>
                </div>
              </div>
              <div class="admin-card" style="margin:0;height:100%;">
                <div class="admin-card-title">Data freshness</div>
                <div class="admin-card-body">
                  <div style="display:flex;flex-direction:column;gap:0.35rem;">
                    <div><span class="status-muted">Last updates check:</span> <span id="kpi-fresh">–</span></div>
                    <div style="color:var(--muted-2);font-size:0.9rem;">Online is based on last_seen within grace window.</div>
                    <div style="color:var(--muted-2);font-size:0.9rem;">Reboot-required is not yet centralized
                      (per-host/campaign).</div>
                    <div id="maintenance-window-status" style="color:var(--muted-2);font-size:0.9rem;">Maintenance window: checking…</div>
                    <div style="display:flex;gap:0.45rem;flex-wrap:wrap;margin-top:0.3rem;">
                      <button class="btn" id="teams-test-alert" type="button">Teams: Send test</button>
                      <button class="btn" id="teams-send-brief" type="button">Teams: Send morning brief</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="admin-card" style="margin:0;height:100%;">
                <div class="admin-card-title">Morning brief</div>
                <div class="admin-card-body">
                  <div id="overview-morning-brief" class="status-muted">Loading…</div>
                </div>
              </div>
            </div>


            <div class="admin-card" style="margin-top:1rem;">
              <div class="admin-card-title" style="display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap;">
                <span>Notification Center</span>
                <button class="btn" id="notifications-refresh" type="button">Reload</button>
              </div>
              <div class="admin-card-body">
                <div id="overview-notifications" class="status-muted">Loading…</div>
              </div>
            </div>

            <div class="admin-card" id="failed-runs-card" style="margin-top:1rem;">
              <div class="admin-card-title" style="display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap;">
                <span>Failed runs (24h)</span>
                <button class="btn" id="failed-runs-refresh" type="button">Reload</button>
              </div>
              <div class="admin-card-body">
                <div style="overflow-x:auto;">
                  <table class="process-table" style="min-width:900px;">
                    <thead>
                      <tr>
                        <th>When</th>
                        <th>Host</th>
                        <th>Job</th>
                        <th style="text-align:right;">Exit</th>
                        <th>Error</th>
                      </tr>
                    </thead>
                    <tbody id="overview-failed-runs">
                      <tr><td colspan="5" style="text-align:center;" class="status-muted">Loading…</td></tr>
                    </tbody>
                  </table>
                </div>
                <div class="admin-note" style="margin-top:0.5rem;">Click a row to view stderr/stdout.</div>
              </div>
            </div>
            <div class="admin-card" style="margin-top:1rem;">
              <div class="admin-card-title"
                style="display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap;">
                <span>Pending updates report</span>
                <div style="display:flex;gap:0.5rem;align-items:center;flex-wrap:wrap;">
                  <label style="color:var(--muted-2);font-size:0.9rem;">Sort</label>
                  <select id="report-sort" class="host-search" style="width:auto;padding:0.35rem 0.5rem;">
                    <option value="security_updates" selected>Security updates</option>
                    <option value="updates">All updates</option>
                    <option value="os_version">OS version</option>
                    <option value="hostname">Hostname</option>
                    <option value="last_seen">Last seen</option>
                  </select>
                  <select id="report-order" class="host-search" style="width:auto;padding:0.35rem 0.5rem;">
                    <option value="desc" selected>Desc</option>
                    <option value="asc">Asc</option>
                  </select>
                  <a class="btn" id="report-download-html" href="/reports/hosts-updates.html" target="_blank"
                    rel="noopener">Download HTML</a>
                  <button class="btn" id="report-refresh" type="button">Reload report</button>
                </div>
              </div>
              <div class="admin-card-body">
                <div style="overflow-x:auto;">
                  <table class="process-table" style="min-width:900px;">
                    <thead>
                      <tr>
                        <th id="th-host" class="sortable-col" title="Sort by host" aria-sort="none" tabindex="0" role="button">
                          Host <span class="sort-indicator" aria-hidden="true">↕</span></th>
                        <th id="th-os" class="sortable-col" title="Sort by OS" aria-sort="none" tabindex="0" role="button">
                          OS <span class="sort-indicator" aria-hidden="true">↕</span></th>
                        <th>Kernel</th>
                        <th>Security</th>
                        <th id="th-updates" class="sortable-col" title="Sort by all updates" aria-sort="none" tabindex="0" role="button">
                          All updates <span class="sort-indicator" aria-hidden="true">↕</span></th>
                        <th>Online</th>
                        <th>Last seen</th>
                      </tr>
                    </thead>
                    <tbody id="overview-updates-report">
                      <tr>
                        <td colspan="7" style="text-align:center;" class="status-muted">Loading…</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    <div class="tab-content-custom" id="hosts-table-tab">
      <div class="server-info-content" style="padding-top:0;">
        <div style="display:flex;align-items:flex-end;justify-content:space-between;gap:1rem;flex-wrap:wrap;">
          <div>
            <h2 style="margin:0 0 0.25rem 0;">Hosts</h2>
            <div style="color:var(--muted-2);font-size:0.95rem;">Sortable fleet table (updates, security, reboot-needed).
              Select rows for bulk actions.</div>
          </div>
        </div>

        <div class="hosts-top-filters" style="display:grid;gap:0.75rem;">
          <input id="host-search" class="host-search" type="text" placeholder="Search hosts (name, id, IP)..." />

          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:0.75rem;align-items:start;">
            <div class="filter-section" id="labels-filter-section" style="margin-top:0;">
              <div class="filter-section-header" id="labels-filter-toggle">
                <div class="filter-section-title">Label filters</div>
                <button class="filter-toggle" type="button" aria-expanded="false" aria-controls="labels-filter-body" id="labels-toggle-btn">+</button>
              </div>

              <div class="filter-section-body" id="labels-filter-body">
                <div class="vuln-row">
                  <select id="label-env" class="host-search">
                    <option value="">Env: Any</option>
                  </select>
                </div>
                <div class="vuln-row">
                  <select id="label-role" class="host-search">
                    <option value="">Role: Any</option>
                  </select>
                </div>
                <div class="vuln-actions">
                  <button class="btn" id="labels-clear">Clear</button>
                </div>

                <div style="margin-top:0.6rem;border-top:1px solid var(--border);padding-top:0.6rem;display:grid;gap:0.45rem;">
                  <div style="font-size:0.82rem;color:var(--muted-2);font-weight:700;">Saved views</div>
                  <input id="saved-view-name" class="host-search" type="text" placeholder="View name (e.g. Prod DBs)" />
                  <div style="display:flex;gap:0.4rem;align-items:center;">
                    <select id="saved-view-select" class="host-search" style="flex:1 1 auto;">
                      <option value="">Select saved view</option>
                    </select>
                  </div>
                  <label style="display:flex;align-items:center;gap:0.4rem;color:var(--muted-2);font-size:0.82rem;">
                    <input id="saved-view-shared" type="checkbox" /> Shared (team)
                  </label>
                  <label style="display:flex;align-items:center;gap:0.4rem;color:var(--muted-2);font-size:0.82rem;">
                    <input id="saved-view-default" type="checkbox" /> Default on startup
                  </label>
                  <div style="display:flex;gap:0.4rem;flex-wrap:wrap;">
                    <button class="btn btn-primary" id="saved-view-save" type="button">Save current</button>
                    <button class="btn" id="saved-view-apply" type="button">Apply</button>
                    <button class="btn" id="saved-view-delete" type="button">Delete</button>
                  </div>
                  <div id="saved-view-status" class="vuln-status" style="margin-top:0;"></div>
                </div>

                <div style="margin-top:0.6rem;border-top:1px solid var(--border);padding-top:0.6rem;display:grid;gap:0.45rem;">
                  <div style="font-size:0.82rem;color:var(--muted-2);font-weight:700;">Create cron from current view</div>
                  <div style="display:flex;gap:0.4rem;flex-wrap:wrap;">
                    <select id="cron-from-filter-action" class="host-search" style="flex:1 1 220px;">
                      <option value="security-campaign" selected>Security campaign</option>
                      <option value="inventory-now">Inventory now</option>
                      <option value="dist-upgrade">Dist-upgrade</option>
                    </select>
                    <select id="cron-from-filter-schedule" class="host-search" style="flex:1 1 220px;">
                      <option value="weekly-sun-0200" selected>Weekly Sunday 02:00</option>
                      <option value="daily-0600">Daily 06:00</option>
                      <option value="once-30m">One-time in 30 min</option>
                    </select>
                  </div>
                  <div style="display:flex;gap:0.4rem;flex-wrap:wrap;">
                    <button class="btn btn-primary" id="cron-from-filter-open" type="button">Open Cron form with visible hosts</button>
                    <button class="btn" id="cron-from-filter-run-now" type="button">Run now (visible hosts)</button>
                  </div>
                  <div style="display:flex;gap:0.4rem;flex-wrap:wrap;">
                    <button class="btn" id="runbook-inventory-now" type="button">Runbook: Inventory now</button>
                    <button class="btn" id="runbook-security-now" type="button">Runbook: Security campaign now</button>
                    <button class="btn" id="runbook-dist-now" type="button">Runbook: Dist-upgrade now</button>
                  </div>
                  <div id="cron-from-filter-status" class="vuln-status" style="margin-top:0;"></div>
                </div>
              </div>
            </div>

            <div class="filter-section" id="vuln-filter-section" style="margin-top:0;">
              <div class="filter-section-header" id="vuln-filter-toggle">
                <div class="filter-section-title">Vulnerability filter</div>
                <button class="filter-toggle" type="button" aria-expanded="false" aria-controls="vuln-filter-body" id="vuln-toggle-btn">+</button>
              </div>

              <div class="filter-section-body" id="vuln-filter-body">
                <div class="vuln-filter">
                  <div class="vuln-row">
                    <input id="vuln-cve" class="host-search" type="text" placeholder="CVE (e.g. CVE-2021-45105)" />
                  </div>
                  <div class="vuln-row">
                    <input id="vuln-package" class="host-search" type="text" placeholder="Package name (e.g. openssl)" />
                  </div>
                  <div class="vuln-row">
                    <input id="vuln-version" class="host-search" type="text" placeholder="Vulnerable version (exact, e.g. 1.1.1w-0+deb11u1)" />
                  </div>
                  <div class="vuln-actions">
                    <button class="btn btn-primary" id="vuln-apply">Show vulnerable</button>
                    <button class="btn" id="vuln-clear" disabled>Clear</button>
                  </div>
                  <div class="vuln-status" id="vuln-status"></div>

                  <div class="vuln-upgrade">
                    <label class="vuln-inline">
                      <input type="checkbox" id="select-visible-hosts" />
                      Select all visible hosts
                    </label>

                    <div id="cve-packages-panel" style="display:none;margin:0.5rem 0 0.25rem 0;">
                      <div style="font-size:0.85rem;color:var(--muted-2);margin-bottom:0.25rem;">Affected packages (CVE)</div>
                      <div id="cve-packages-list" style="display:flex;flex-direction:column;gap:0.25rem;max-height:220px;overflow:auto;padding:0.25rem 0.25rem;border:1px solid var(--border);border-radius:8px;"></div>
                      <div id="cve-plan-summary" style="font-size:0.8rem;color:var(--muted-2);margin-top:0.35rem;"></div>
                      <div style="font-size:0.8rem;color:var(--muted-2);margin-top:0.25rem;">We’ll upgrade the selected packages on each selected host, but only if that host reported the package as affected.</div>
                    </div>

                    <button class="btn btn-primary" id="upgrade-selected" disabled>Upgrade selected</button>
                    <div class="vuln-status" id="upgrade-status"></div>
                  </div>
                </div>
              </div>
            </div>

            <div class="filter-section" id="ansible-filter-section" style="margin-top:0;">
              <div class="filter-section-header" id="ansible-filter-toggle">
                <div class="filter-section-title">Ansible hosts</div>
                <button class="filter-toggle" type="button" aria-expanded="false" aria-controls="ansible-filter-body" id="ansible-toggle-btn">+</button>
              </div>
              <div class="filter-section-body" id="ansible-filter-body">
                <div class="vuln-row">
                  <select id="ansible-playbook" class="host-search">
                    <option value="">Select playbook</option>
                  </select>
                </div>
                <div class="vuln-actions">
                  <button class="btn btn-primary" id="ansible-open" disabled>Configure & Run</button>
                  <button class="btn" id="ansible-refresh">Refresh</button>
                </div>
                <div class="vuln-status" id="ansible-status"></div>
              </div>
            </div>
          </div>
        </div>

        <div style="display:flex;align-items:center;justify-content:space-between;gap:0.5rem;flex-wrap:wrap;margin-top:0.75rem;">
          <span id="hosts-visible-counter" style="color:var(--muted-2);font-size:0.9rem;">0 / 0 hosts shown</span>
          <div style="display:flex;align-items:center;gap:0.5rem;flex-wrap:wrap;">
            <label style="color:var(--muted-2);font-size:0.9rem;">Sort</label>
          <select id="hosts-sort" class="host-search" style="width:auto;padding:0.35rem 0.5rem;">
            <option value="hostname" selected>Host</option>
            <option value="os_version">OS</option>
            <option value="updates">All updates</option>
            <option value="security_updates">Security updates</option>
            <option value="last_seen">Last seen</option>
          </select>
          <select id="hosts-order" class="host-search" style="width:auto;padding:0.35rem 0.5rem;">
            <option value="asc" selected>Asc</option>
            <option value="desc">Desc</option>
          </select>
          <button class="btn" id="hosts-reload" type="button">Reload</button>
          <button class="btn" id="hosts-cleanup-offline" type="button" title="Delete hosts that have been offline for a while">Clean offline…</button>
          </div>
        </div>

        <div style="display:flex;gap:0.5rem;flex-wrap:wrap;margin-top:0.75rem;">
          <button class="btn btn-primary" id="hosts-bulk-inventory" type="button">Inventory now (selected)</button>
          <button class="btn btn-primary" id="hosts-bulk-security" type="button">Security campaign (selected)</button>
          <button class="btn" id="hosts-bulk-dist" type="button">dist-upgrade (selected)</button>
          <span id="hosts-bulk-status" style="color:var(--muted-2);font-size:0.9rem;"></span>
        </div>


        <div class="hosts-table-wrap" style="margin-top:0.75rem;">
          <table class="process-table hosts-table">
            <thead>
              <tr>
                <th style="width:36px;"><input type="checkbox" id="hosts-select-all" /></th>
                <th class="sortable-col" id="hosts-th-host" title="Sort by host" tabindex="0" role="button">Host <span class="sort-indicator" aria-hidden="true">↕</span></th>
                <th class="sortable-col" id="hosts-th-os" title="Sort by OS" tabindex="0" role="button">OS <span class="sort-indicator" aria-hidden="true">↕</span></th>
                <th>Kernel</th>
                <th class="sortable-col" style="text-align:right;" id="hosts-th-sec" title="Sort by security updates" tabindex="0" role="button">Security <span class="sort-indicator" aria-hidden="true">↕</span></th>
                <th class="sortable-col" style="text-align:right;" id="hosts-th-upd" title="Sort by all updates" tabindex="0" role="button">All updates <span class="sort-indicator" aria-hidden="true">↕</span></th>
                <th>Reboot</th>
                <th>Online</th>
                <th class="sortable-col" id="hosts-th-last" title="Sort by last seen" tabindex="0" role="button">Last seen <span class="sort-indicator" aria-hidden="true">↕</span></th>
              </tr>
            </thead>
            <tbody id="hosts-table-body">
              <tr>
                <td colspan="9" style="text-align:center;" class="status-muted">Loading…</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>


    <div class="tab-content-custom" id="cronjobs-tab">
      <div class="admin-content">
        <div class="section-title">Cronjobs</div>
        <div class="admin-note" style="margin-bottom:0.75rem;">One-shot scheduled actions (safe mode). Runs as the agent job type (e.g. dist-upgrade uses sudo on the host).</div>

        <div class="admin-card" style="margin-bottom:1rem;">
          <div class="admin-card-title">Create cronjob</div>
          <div class="admin-card-body">
            <div style="display:flex;gap:0.75rem;flex-wrap:wrap;align-items:flex-end;">
              <div style="min-width:220px;flex:1;">
                <label style="display:block;color:var(--muted-2);font-size:0.85rem;margin-bottom:0.25rem;">Name (optional)</label>
                <input id="cron-name" class="host-search" type="text" placeholder="e.g. weekly dist-upgrade" />
              </div>
              <div style="min-width:220px;">
                <label style="display:block;color:var(--muted-2);font-size:0.85rem;margin-bottom:0.25rem;">Run at (your local time)</label>
                <input id="cron-run-at" class="host-search" type="datetime-local" />
              </div>
              <div style="min-width:220px;">
                <label style="display:block;color:var(--muted-2);font-size:0.85rem;margin-bottom:0.25rem;">Schedule</label>
                <select id="cron-schedule-kind" class="host-search">
                  <option value="once" selected>Once</option>
                  <option value="daily">Daily</option>
                  <option value="weekly">Weekly</option>
                  <option value="monthly">Monthly</option>
                </select>
              </div>
              <div style="min-width:220px;display:none;" id="cron-weekday-wrap">
                <label style="display:block;color:var(--muted-2);font-size:0.85rem;margin-bottom:0.25rem;">Weekday</label>
                <select id="cron-weekday" class="host-search">
                  <option value="0">Mon</option><option value="1">Tue</option><option value="2">Wed</option><option value="3">Thu</option><option value="4">Fri</option><option value="5">Sat</option><option value="6">Sun</option>
                </select>
              </div>
              <div style="min-width:220px;display:none;" id="cron-dom-wrap">
                <label style="display:block;color:var(--muted-2);font-size:0.85rem;margin-bottom:0.25rem;">Day of month</label>
                <input id="cron-day-of-month" class="host-search" type="number" min="1" max="31" placeholder="12" />
              </div>
              <div style="min-width:220px;display:none;" id="cron-time-wrap">
                <label style="display:block;color:var(--muted-2);font-size:0.85rem;margin-bottom:0.25rem;">Time</label>
                <input id="cron-time" class="host-search" type="time" />
              </div>

              <div style="min-width:220px;">
                <label style="display:block;color:var(--muted-2);font-size:0.85rem;margin-bottom:0.25rem;">Action</label>
                <select id="cron-action" class="host-search">
                  <option value="dist-upgrade" selected>dist-upgrade</option>
                  <option value="inventory-now">inventory-now</option>
                  <option value="security-campaign">security campaign</option>
                </select>
              </div>
              <button class="btn" id="cron-hosts-open" type="button">Choose hosts…</button>
              <button class="btn btn-primary" id="cron-create" type="button">Create (selected hosts)</button>
              <span id="cron-create-status" style="color:var(--muted-2);font-size:0.9rem;"></span>
            </div>
          </div>
        </div>

        

        <div class="admin-card" id="cron-hosts-panel" style="display:none;margin-bottom:1rem;">
          <div class="admin-card-title" style="display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap;">
            <span>Select hosts for this cronjob</span>
            <div style="display:flex;gap:0.5rem;flex-wrap:wrap;align-items:center;">
              <button class="btn" id="cron-hosts-select-all" type="button">Select all</button>
              <button class="btn" id="cron-hosts-select-none" type="button">Select none</button>
              <button class="btn" id="cron-hosts-close" type="button">Hide</button>
            </div>
          </div>
          <div class="admin-card-body">
            <div class="admin-note" style="margin-top:-0.25rem;">This selection is only for cronjobs (independent of the Hosts tab checkboxes).</div>
            <div class="input-with-clear" style="max-width:520px;">
              <input id="cron-hosts-search" class="host-search" type="text" placeholder="Filter hosts (name, id, IP)…" />
              <button class="clear-btn" id="cron-hosts-search-clear" type="button" aria-label="Clear filter">×</button>
            </div>
            <div id="cron-hosts-list" style="margin-top:0.75rem;max-height:320px;overflow:auto;border:1px solid var(--border);border-radius:10px;background:var(--panel-2);padding:0.5rem;"></div>
            <div style="margin-top:0.5rem;color:var(--muted-2);font-size:0.9rem;">Selected: <span id="cron-hosts-count">0</span></div>
          </div>
        </div>
<div class="admin-card">
          <div class="admin-card-title" style="display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap;">
            <span>My cronjobs</span>
            <button class="btn" id="cron-refresh" type="button">Reload</button>
          </div>
          <div class="admin-card-body">
            <div style="overflow-x:auto;">
              <table class="process-table" style="min-width:900px;">
                <thead>
                  <tr>
                    <th>Run at</th>
                    <th>Name</th>
                    <th>Action</th>
                    <th>Targets</th>
                    <th>Status</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="cronjobs-table">
                  <tr><td colspan="6" style="text-align:center;" class="status-muted">Loading…</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-content-custom" id="sshkeys-tab">
      <div class="admin-content">
        <div class="section-title">SSH Keys</div>
        <div class="admin-note" style="margin-bottom:0.75rem;">Upload your public key and request deployment to hosts. An admin must approve. Keys are installed into <code>authorized_keys</code> and a restricted NOPASSWD sudo profile is applied (variant B).</div>

        <div class="admin-card" style="margin-bottom:1rem;">
          <div class="admin-card-title">Add public key</div>
          <div class="admin-card-body">
            <div style="display:flex;gap:0.75rem;flex-wrap:wrap;align-items:flex-end;">
              <div style="min-width:220px;flex:1;">
                <label style="display:block;color:var(--muted-2);font-size:0.85rem;margin-bottom:0.25rem;">Name (optional)</label>
                <input id="sshkey-name" class="host-search" type="text" placeholder="e.g. laptop" />
              </div>
              <div style="min-width:520px;flex:3;">
                <label style="display:block;color:var(--muted-2);font-size:0.85rem;margin-bottom:0.25rem;">Public key</label>
                <input id="sshkey-pub" class="host-search" type="text" placeholder="ssh-ed25519 AAAA... comment" />
              </div>
              <button class="btn btn-primary" id="sshkey-add" type="button">Add</button>
              <span id="sshkey-add-status" style="color:var(--muted-2);font-size:0.9rem;"></span>
            </div>
          </div>
        </div>

        <div class="admin-card" style="margin-bottom:1rem;">
          <div class="admin-card-title" style="display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap;">
            <span id="sshkeys-list-title">My keys</span>
            <button class="btn" id="sshkey-refresh" type="button">Reload</button>
          </div>
          <div class="admin-card-body">
            <div style="overflow-x:auto;">
              <table class="process-table" style="min-width:900px;">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Fingerprint</th>
                    <th>Public key</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="sshkeys-table">
                  <tr><td colspan="4" style="text-align:center;" class="status-muted">Loading…</td></tr>
                </tbody>
              </table>
            </div>

            <div style="margin-top:0.75rem;display:flex;gap:0.5rem;align-items:center;flex-wrap:wrap;">
              <button class="btn" id="sshkey-hosts-open" type="button">Choose hosts…</button>
              <button class="btn btn-primary" id="sshkey-request-deploy" type="button">Request deploy (selected key + selected hosts)</button>
              <span id="sshkey-request-status" style="color:var(--muted-2);font-size:0.9rem;"></span>
            </div>

            <div class="admin-card" id="sshkey-hosts-panel" style="display:none;margin-top:0.75rem;">
              <div class="admin-card-title" style="display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap;">
                <span>Select hosts</span>
                <div style="display:flex;gap:0.5rem;flex-wrap:wrap;align-items:center;">
                  <button class="btn" id="sshkey-hosts-select-all" type="button">Select all</button>
                  <button class="btn" id="sshkey-hosts-select-none" type="button">Select none</button>
                  <button class="btn" id="sshkey-hosts-close" type="button">Hide</button>
                </div>
              </div>
              <div class="admin-card-body">
                <div class="input-with-clear" style="max-width:520px;">
                  <input id="sshkey-hosts-search" class="host-search" type="text" placeholder="Filter hosts (name, id, IP, OS)…" />
                  <button class="clear-btn" id="sshkey-hosts-search-clear" type="button" aria-label="Clear filter">×</button>
                </div>
                <div id="sshkey-hosts-list" style="margin-top:0.75rem;max-height:320px;overflow:auto;border:1px solid var(--border);border-radius:10px;background:var(--panel-2);padding:0.5rem;"></div>
                <div style="margin-top:0.5rem;color:var(--muted-2);font-size:0.9rem;">Selected: <span id="sshkey-hosts-count">0</span></div>
              </div>
            </div>

          </div>
        </div>

        <div class="admin-card">
          <div class="admin-card-title">My deployment requests</div>
          <div class="admin-card-body">
            <div style="overflow-x:auto;">
              <table class="process-table" style="min-width:900px;">
                <thead>
                  <tr>
                    <th>Created</th>
                    <th>Key</th>
                    <th>Targets</th>
                    <th>Status</th>
                    <th>Approved by</th>
                    <th>Error</th>
                  </tr>
                </thead>
                <tbody id="sshkey-requests-table">
                  <tr><td colspan="6" style="text-align:center;" class="status-muted">Loading…</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="admin-card" id="sshkey-admin-keys" style="margin-top:1rem;display:none;">
          <div class="admin-card-title" style="display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap;">
            <span>Admin: all users’ SSH keys</span>
            <button class="btn" id="sshkey-admin-keys-refresh" type="button">Reload</button>
          </div>
          <div class="admin-card-body">
            <div style="overflow-x:auto;">
              <table class="process-table" style="min-width:900px;">
                <thead>
                  <tr>
                    <th>Created</th>
                    <th>User</th>
                    <th>Name</th>
                    <th>Fingerprint</th>
                    <th>Public key</th>
                  </tr>
                </thead>
                <tbody id="sshkey-admin-keys-table">
                  <tr><td colspan="5" style="text-align:center;" class="status-muted">Loading…</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="admin-card" id="sshkey-admin-approvals" style="margin-top:1rem;display:none;">
          <div class="admin-card-title" style="display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap;">
            <span>Admin: pending deployment approvals</span>
            <button class="btn" id="sshkey-admin-refresh" type="button">Reload</button>
          </div>
          <div class="admin-card-body">
            <div style="overflow-x:auto;">
              <table class="process-table" style="min-width:900px;">
                <thead>
                  <tr>
                    <th>Created</th>
                    <th>User</th>
                    <th>Key</th>
                    <th>Targets</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="sshkey-admin-table">
                  <tr><td colspan="5" style="text-align:center;" class="status-muted">Loading…</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </div>
    <div class="tab-content-custom" id="terminal-tab">
      <div class="host-context-bar" style="margin:0 1rem 0.5rem;">
        Host: <b class="host-context-name">—</b>
        <span class="host-subsep">•</span>
        IP: <code class="host-context-ip">—</code>
      </div>
      <div style="display:flex;justify-content:flex-end;margin:0 1rem 0.5rem;">
        <button class="btn" id="terminal-run-pending-cmd" type="button" style="display:none;">Run pending package command</button>
      </div>
      <div class="terminal-container">
        <div id="terminal"></div>
      </div>
    </div>

    <div class="tab-content-custom" id="users-tab">
      <div class="users-content">
        <div class="host-context-bar" style="margin-bottom:0.65rem;">
          Host: <b class="host-context-name">—</b>
          <span class="host-subsep">•</span>
          IP: <code class="host-context-ip">—</code>
        </div>
        <div class="section-title">System Users & Sudo Rights</div>
        <div class="admin-note" id="users-access-note" style="display:none;">Admin access required to lock or unlock
          users.</div>
        <div id="users-list">
          <div class="loading">Select a host to view users...</div>
        </div>
      </div>
    </div>

    <div class="tab-content-custom" id="admin-tab">
      <div class="admin-content">
        <div class="section-title">Admin</div>
        <div class="admin-panels" style="display:grid;grid-template-columns:1fr 1.2fr;gap:1rem;align-items:start;">
          <div>
            <div class="admin-card">
              <div class="admin-card-title">Create user</div>
              <div class="admin-card-body">
                <input id="register-username" class="admin-input" type="text" placeholder="New username" />
                <input id="register-password" class="admin-input" type="password" placeholder="Temporary password" />
                <button class="btn btn-primary" id="register-user-btn">Create user</button>
                <div class="admin-status" id="register-status"></div>
              </div>
            </div>

            <div class="admin-card" style="margin-top:1rem;">
              <div class="admin-card-title">Reset password</div>
              <div class="admin-card-body">
                <input id="reset-username" class="admin-input" type="text" placeholder="Username to reset" />
                <input id="reset-password" class="admin-input" type="password" placeholder="New password" />
                <button class="btn btn-primary" id="reset-password-btn">Reset password</button>
                <div class="admin-status" id="reset-status"></div>
              </div>
            </div>

            <div class="admin-card" id="admin-access-note" style="margin-top:1rem;">
              <div class="admin-card-title">Access</div>
              <div class="admin-card-body">
                <div class="admin-note">Admin access required to manage app users.</div>
              </div>
            </div>
          </div>

          <div>
            <div class="admin-card" id="admin-users-card">
              <div class="admin-card-title" style="display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap;">
                <span>Users</span>
                <button class="btn" id="admin-users-refresh" type="button">Reload</button>
              </div>
              <div class="admin-card-body">
                <div style="overflow-x:auto;">
                  <table class="process-table" style="min-width:720px;">
                    <thead>
                      <tr>
                        <th>Username</th>
                        <th>Role</th>
                        <th>Active</th>
                        <th>MFA</th>
                        <th>Created</th>
                        <th>Scope selectors</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody id="admin-users-table">
                      <tr><td colspan="7" style="text-align:center;" class="status-muted">Loading…</td></tr>
                    </tbody>
                  </table>
                </div>
                <div class="admin-status" id="admin-users-status"></div>
              </div>
            </div>

            <div class="admin-card" id="admin-oidc-map-preview-card" style="margin-top:1rem;">
              <div class="admin-card-title" style="display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap;">
                <span>OIDC mapping preview</span>
                <button class="btn" id="admin-oidc-preview-run" type="button">Run preview</button>
              </div>
              <div class="admin-card-body">
                <label style="display:block;color:var(--muted-2);font-size:0.85rem;margin-bottom:0.35rem;">Claims JSON</label>
                <textarea id="admin-oidc-preview-input" class="admin-input" rows="6" style="width:100%;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;" placeholder='{"sub":"123","email":"user@example.com","groups":["fleet-ops"]}'></textarea>
                <label style="display:block;color:var(--muted-2);font-size:0.85rem;margin:0.75rem 0 0.35rem;">Result</label>
                <textarea id="admin-oidc-preview-output" class="admin-input" rows="6" readonly style="width:100%;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;"></textarea>
                <div class="admin-status" id="admin-oidc-preview-status"></div>
              </div>
            </div>

            <div class="admin-card" id="admin-approvals-card" style="margin-top:1rem;">
              <div class="admin-card-title" style="display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap;">
                <span>High-risk approvals</span>
                <div style="display:flex;gap:0.5rem;flex-wrap:wrap;align-items:center;">
                  <input id="approvals-filter-action" class="host-search" style="max-width:180px;" type="text" placeholder="Action" />
                  <input id="approvals-filter-requester" class="host-search" style="max-width:180px;" type="text" placeholder="Requester" />
                  <select id="approvals-filter-age" class="host-search" style="width:auto;padding:0.35rem 0.5rem;max-width:180px;">
                    <option value="">Any age</option>
                    <option value="15">≤ 15 min</option>
                    <option value="60">≤ 1 hour</option>
                    <option value="240">≤ 4 hours</option>
                    <option value="1440">≤ 24 hours</option>
                  </select>
                  <select id="approvals-filter-mode" class="host-search" style="width:auto;padding:0.35rem 0.5rem;max-width:200px;">
                    <option value="pending">Pending only</option>
                    <option value="recent">Last 24h (all states)</option>
                  </select>
                  <select id="approvals-filter-sort" class="host-search" style="width:auto;padding:0.35rem 0.5rem;max-width:200px;">
                    <option value="created_desc">Newest first</option>
                    <option value="created_asc">Oldest first</option>
                    <option value="action_asc">Action A→Z</option>
                    <option value="requester_asc">Requester A→Z</option>
                  </select>
                  <button class="btn" id="admin-approvals-refresh" type="button">Reload</button>
                </div>
              </div>
              <div class="admin-card-body">
                <div style="overflow-x:auto;">
                  <table class="process-table" style="min-width:900px;">
                    <thead>
                      <tr>
                        <th>Time</th>
                        <th>Requester</th>
                        <th>Action</th>
                        <th>Targets</th>
                        <th style="text-align:right;">Actions</th>
                      </tr>
                    </thead>
                    <tbody id="admin-approvals-table">
                      <tr><td colspan="5" style="text-align:center;" class="status-muted">Loading…</td></tr>
                    </tbody>
                  </table>
                </div>
                <div class="admin-status" id="admin-approvals-status"></div>
              </div>
            </div>

            <div class="admin-card" id="admin-dedupe-card" style="margin-top:1rem;">
              <div class="admin-card-title" style="display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap;">
                <span>Notification dedupe state</span>
                <div style="display:flex;gap:0.5rem;flex-wrap:wrap;align-items:center;">
                  <input id="dedupe-filter-kind" class="host-search" style="max-width:180px;" type="text" placeholder="Kind (optional)" />
                  <select id="dedupe-filter-minutes" class="host-search" style="width:auto;padding:0.35rem 0.5rem;max-width:180px;">
                    <option value="60">Last 1h</option>
                    <option value="240">Last 4h</option>
                    <option value="1440" selected>Last 24h</option>
                    <option value="10080">Last 7d</option>
                  </select>
                  <button class="btn" id="admin-dedupe-refresh" type="button">Reload</button>
                </div>
              </div>
              <div class="admin-card-body">
                <div style="overflow-x:auto;">
                  <table class="process-table" style="min-width:900px;">
                    <thead>
                      <tr>
                        <th>Last emitted</th>
                        <th>Kind</th>
                        <th>Severity</th>
                        <th>Dedupe key</th>
                        <th>Title</th>
                      </tr>
                    </thead>
                    <tbody id="admin-dedupe-table">
                      <tr><td colspan="5" style="text-align:center;" class="status-muted">Loading…</td></tr>
                    </tbody>
                  </table>
                </div>
                <div class="admin-status" id="admin-dedupe-status"></div>
              </div>
            </div>

            <div class="admin-card" id="admin-audit-card" style="margin-top:1rem;">
              <div class="admin-card-title" style="display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap;">
                <span>Audit log</span>
                <div style="display:flex;gap:0.5rem;flex-wrap:wrap;align-items:center;">
                  <input id="audit-filter-action" class="host-search" style="max-width:220px;" type="text" placeholder="Action (e.g. auth.login)" />
                  <input id="audit-filter-actor" class="host-search" style="max-width:200px;" type="text" placeholder="Actor (username)" />
                  <button class="btn" id="admin-audit-refresh" type="button">Reload</button>
                </div>
              </div>
              <div class="admin-card-body">
                <div style="overflow-x:auto;">
                  <table class="process-table" style="min-width:900px;">
                    <thead>
                      <tr>
                        <th>Time</th>
                        <th>Action</th>
                        <th>Actor</th>
                        <th>Target</th>
                        <th>IP</th>
                        <th>Meta</th>
                      </tr>
                    </thead>
                    <tbody id="admin-audit-table">
                      <tr><td colspan="6" style="text-align:center;" class="status-muted">Loading…</td></tr>
                    </tbody>
                  </table>
                </div>
                <div class="admin-status" id="admin-audit-status"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-content-custom" id="services-tab">
      <div class="services-content">
        <div class="host-context-bar" style="margin-bottom:0.65rem;">
          Host: <b class="host-context-name">—</b>
          <span class="host-subsep">•</span>
          IP: <code class="host-context-ip">—</code>
        </div>
        <div class="section-title">System Services</div>
        <div id="services-list">
          <div class="loading">Select a host to view services...</div>
        </div>
      </div>
    </div>

    <div class="tab-content-custom" id="packages-tab">
      <div class="packages-content">
        <div class="host-context-bar" style="margin-bottom:0.65rem;">
          Host: <b class="host-context-name">—</b>
          <span class="host-subsep">•</span>
          IP: <code class="host-context-ip">—</code>
        </div>
        <div class="section-title">Installed Packages</div>
        <div style="display:flex;gap:1rem;flex-wrap:wrap;align-items:center;margin-bottom:0.75rem;">
          <div class="input-with-clear">
            <input id="packages-search" class="host-search" type="text"
              placeholder="Search installed packages (name/version)..." />
            <button class="clear-btn" id="packages-search-clear" type="button" aria-label="Clear search">×</button>
          </div>
          <button class="btn btn-primary" id="packages-check-updates">Check updates</button>
          <label class="vuln-inline" style="margin:0;">
            <input type="checkbox" id="packages-updates-only" />
            Updates only
          </label>
          <div id="packages-meta" style="font-size:0.85rem;color:var(--muted-2);"></div>
        </div>
        <div style="display:flex;gap:1rem;flex-wrap:wrap;align-items:center;margin-bottom:1rem;">
          <label class="vuln-inline" style="margin:0;">
            <input type="checkbox" id="select-visible-packages" />
            Select all visible packages
          </label>
          <label class="vuln-inline" style="margin:0;">
            <input type="checkbox" id="pkg-interactive-terminal" />
            Interactive (Terminal)
          </label>
          <button class="btn btn-primary" id="pkg-upgrade-selected" disabled>Upgrade selected</button>
          <button class="btn btn-warning" id="pkg-reinstall-selected" disabled>Reinstall selected</button>
          <button class="btn btn-danger" id="pkg-remove-selected" disabled>Remove selected</button>
          <div id="pkg-actions-status" style="font-size:0.85rem;color:var(--muted-2);"></div>
        </div>
        <div class="packages-split">
          <div id="packages-list">
            <div class="loading">Select a host to view packages...</div>
          </div>
          <div id="package-info" class="package-info-panel"></div>
        </div>
      </div>
    </div>
  </div>
  </div>

  <div class="modal-overlay" id="ansible-modal" aria-hidden="true" hidden>
    <div class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="ansible-modal-title">
      <div class="modal-header">
        <div class="modal-title" id="ansible-modal-title">Run Ansible playbook</div>
        <button class="btn modal-close" id="ansible-modal-close" type="button">Close</button>
      </div>
      <div class="modal-body">
        <div class="modal-meta" id="ansible-modal-meta"></div>
        <div class="modal-form" id="ansible-modal-form"></div>
        <div class="modal-actions">
          <button class="btn btn-primary" id="ansible-modal-run" type="button">Run</button>
        </div>
        <div class="modal-status" id="ansible-modal-status"></div>
        <div class="modal-meta" id="ansible-modal-log"></div>
        <pre class="modal-output" id="ansible-modal-output"></pre>
        <div class="modal-actions" style="margin-top:12px;justify-content:space-between;">
          <div class="modal-meta" id="ansible-logs-status"></div>
          <button class="btn" id="ansible-logs-refresh" type="button">View logs</button>
        </div>
        <div class="modal-meta" id="ansible-logs-list"></div>
        <div class="modal-actions" style="margin-top:12px;justify-content:flex-end;">
          <button class="btn" id="ansible-output-copy" type="button">Copy output</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="user-modal" aria-hidden="true" hidden>
    <div class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="user-modal-title" style="width:min(1000px,96vw);max-width:96vw;max-height:92vh;display:flex;flex-direction:column;">
      <div class="modal-header">
        <div class="modal-title" id="user-modal-title">User details</div>
        <button class="btn modal-close" id="user-modal-close" type="button">Close</button>
      </div>
      <div class="modal-body" style="flex:1;min-height:0;overflow:auto;">
        <div class="modal-meta" id="user-modal-meta"></div>
        <div class="modal-output" id="user-modal-output" style="white-space:normal;"></div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="service-modal" aria-hidden="true" hidden>
    <div class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="service-modal-title" style="width:min(1000px,96vw);max-width:96vw;max-height:92vh;display:flex;flex-direction:column;">
      <div class="modal-header">
        <div class="modal-title" id="service-modal-title">Service details</div>
        <button class="btn modal-close" id="service-modal-close" type="button">Close</button>
      </div>
      <div class="modal-body" style="flex:1;min-height:0;overflow:auto;">
        <div class="modal-meta" id="service-modal-meta"></div>
        <div class="modal-output" id="service-modal-output" style="white-space:normal;"></div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="disk-modal" aria-hidden="true" hidden>
    <div class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="disk-modal-title" style="width:min(1400px,98vw);max-width:98vw;max-height:96vh;display:flex;flex-direction:column;">
      <div class="modal-header">
        <div class="modal-title" id="disk-modal-title">Disk usage (df -h)</div>
        <button class="btn modal-close" id="disk-modal-close" type="button">Close</button>
      </div>
      <div class="modal-body" style="flex:1;min-height:0;overflow:auto;max-height:none;">
        <div class="modal-meta" id="disk-modal-meta"></div>
        <div class="modal-actions" style="margin:8px 0;justify-content:space-between;position:sticky;top:0;background:var(--panel-2, transparent);padding:6px 0;z-index:2;gap:12px;flex-wrap:wrap;">
          <label style="display:flex;align-items:center;gap:8px;color:var(--muted-2);font-size:0.9rem;user-select:none;">
            <input type="checkbox" id="disk-modal-show-virtual" />
            Show virtual filesystems (tmpfs/overlay/squashfs)
          </label>
          <button class="btn" id="disk-modal-refresh" type="button">Refresh</button>
        </div>
        <div class="modal-output" id="disk-modal-output" style="white-space:normal;max-height:none;overflow:visible;"></div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="sshkey-approval-modal" aria-hidden="true" hidden>
    <div class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="sshkey-approval-modal-title">
      <div class="modal-header">
        <div class="modal-title" id="sshkey-approval-modal-title">Deployment approval details</div>
        <button class="btn modal-close" id="sshkey-approval-modal-close" type="button">Close</button>
      </div>
      <div class="modal-body">
        <div class="modal-meta" id="sshkey-approval-modal-meta"></div>
        <div class="modal-actions" style="margin:8px 0;justify-content:flex-end;">
          <a class="btn" id="sshkey-approval-modal-download-stdout" href="#" download style="display:none;">Download stdout</a>
          <a class="btn" id="sshkey-approval-modal-download-stderr" href="#" download style="display:none;">Download stderr</a>
          <a class="btn" id="sshkey-approval-modal-download-zip" href="#" download style="display:none;">Download logs.zip</a>
        </div>
        <pre class="modal-output" id="sshkey-approval-modal-targets" style="white-space:pre-wrap;"></pre>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="mfa-modal" aria-hidden="true" hidden>
    <div class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="mfa-modal-title" style="width:min(720px,96vw);max-width:96vw;">
      <div class="modal-header">
        <div class="modal-title" id="mfa-modal-title">MFA</div>
        <!-- No close button: MFA is required for privileged roles -->
      </div>
      <div class="modal-body">
        <div class="modal-meta" id="mfa-modal-status" style="color:var(--muted-2);"></div>
        <div id="mfa-modal-body"></div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="audit-detail-modal" aria-hidden="true" hidden>
    <div class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="audit-detail-modal-title" style="width:min(1100px,96vw);max-width:96vw;max-height:92vh;display:flex;flex-direction:column;">
      <div class="modal-header">
        <div class="modal-title" id="audit-detail-modal-title">Audit event</div>
        <button class="btn modal-close" id="audit-detail-modal-close" type="button">Close</button>
      </div>
      <div class="modal-body" style="flex:1;min-height:0;overflow:auto;">
        <div class="modal-meta" id="audit-detail-modal-meta"></div>
        <textarea id="audit-detail-modal-output" readonly style="width:100%;min-height:420px;resize:vertical;padding:10px;border:1px solid var(--border);border-radius:10px;background:var(--panel-2);color:var(--text);font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;user-select:text;"></textarea>
        <div class="modal-actions" style="margin-top:12px;justify-content:flex-end;gap:8px;">
          <button class="btn" id="audit-detail-modal-copy" type="button">Copy</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="approval-detail-modal" aria-hidden="true" hidden>
    <div class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="approval-detail-modal-title" style="width:min(1100px,96vw);max-width:96vw;max-height:92vh;display:flex;flex-direction:column;">
      <div class="modal-header">
        <div class="modal-title" id="approval-detail-modal-title">Approval request</div>
        <button class="btn modal-close" id="approval-detail-modal-close" type="button">Close</button>
      </div>
      <div class="modal-body" style="flex:1;min-height:0;overflow:auto;">
        <div class="modal-meta" id="approval-detail-modal-meta"></div>
        <textarea id="approval-detail-modal-output" readonly style="width:100%;min-height:420px;resize:vertical;padding:10px;border:1px solid var(--border);border-radius:10px;background:var(--panel-2);color:var(--text);font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;user-select:text;"></textarea>
        <div class="modal-actions" style="margin-top:12px;justify-content:flex-end;gap:8px;">
          <button class="btn" id="approval-detail-modal-copy" type="button">Copy</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toast-container" class="toast-container" aria-live="polite" aria-atomic="true"></div>

  <script nonce="__CSP_NONCE__">
    // Init xterm only when the container exists. If this throws early, it can break other UI JS (e.g. theme toggle).
    let term = null;
    let termFitAddon = null;

    function fitTerminalViewport() {
      if (!term) return;
      const tab = document.getElementById('terminal-tab');
      if (!tab || !tab.classList.contains('active')) return;
      try {
        if (termFitAddon && typeof termFitAddon.fit === 'function') {
          termFitAddon.fit();
        }
      } catch (_) { }
      try { term.focus(); } catch { }
    }

    function initTerminalOnce() {
      if (term) return;
      const termEl = document.getElementById('terminal');
      if (!termEl) return;
      term = new Terminal({
        convertEol: true,
        theme: {
          background: '#1e1e1e',
          foreground: '#d4d4d4',
          cursor: '#aeafad',
          selection: '#264f78',
          black: '#000000',
          red: '#cd3131',
          green: '#0dbc79',
          yellow: '#e5e510',
          blue: '#2472c8',
          magenta: '#bc3fbc',
          cyan: '#11a8cd',
          white: '#e5e5e5',
          brightBlack: '#666666',
          brightRed: '#f14c4c',
          brightGreen: '#23d18b',
          brightYellow: '#f5f543',
          brightBlue: '#3b8eea',
          brightMagenta: '#d670d6',
          brightCyan: '#29b8db',
          brightWhite: '#e5e5e5'
        }
      });
      term.open(termEl);
      try {
        if (window.FitAddon && typeof window.FitAddon.FitAddon === 'function') {
          termFitAddon = new window.FitAddon.FitAddon();
          term.loadAddon(termFitAddon);
          termFitAddon.fit();
        }
      } catch (_) { }
      // Ensure keystrokes go to xterm immediately (otherwise onData won't fire until focused).
      try { term.focus(); } catch { }
      termEl.addEventListener('mousedown', () => { try { term.focus(); } catch { } });
      termEl.addEventListener('touchstart', () => { try { term.focus(); } catch { } }, { passive: true });
      window.addEventListener('resize', () => {
        window.requestAnimationFrame(fitTerminalViewport);
      });
    }

    let ws = null;
    let currentAgentId = null;
    let pendingInteractivePackageCmd = null;
    var currentUsername = null;
    var adminUsername = null;
    var currentPermissions = {};
    var approvalActionFeedback = {}; // request_id -> short result text

    // Attach terminal input handler ONCE.
    // If we attach this inside connect(), it will stack and each keystroke gets sent multiple times.
    let terminalInputHandlerAttached = false;
    function attachTerminalInputHandlerOnce() {
      if (!term || terminalInputHandlerAttached) return;
      terminalInputHandlerAttached = true;
      term.onData(data => {
        if (ws && ws.readyState === 1) {
          ws.send(new TextEncoder().encode(data));
        }
      });
    }

    function updateTerminalPendingCmdButton() {
      const btn = document.getElementById('terminal-run-pending-cmd');
      if (!btn) return;
      btn.style.display = pendingInteractivePackageCmd ? 'inline-flex' : 'none';
      btn.disabled = !pendingInteractivePackageCmd;
    }

    function runPendingInteractivePackageCommand() {
      if (!pendingInteractivePackageCmd) return;
      if (!(ws && ws.readyState === 1)) {
        showToast('Terminal not connected yet.', 'error', 3500);
        return;
      }
      try {
        ws.send(new TextEncoder().encode(pendingInteractivePackageCmd + '\n'));
        pendingInteractivePackageCmd = null;
        updateTerminalPendingCmdButton();
        showToast('Sent pending package command to terminal', 'success');
      } catch (e) {
        showToast(`Failed to send pending command: ${e.message || e}`, 'error', 5000);
      }
    }

    // Tab switching removed - tabs are now accessed via server info buttons only

    let loadGraphChart = null;
    let loadGraphData = [];
    const metricsLifecycleState = createUiStateAccess('hostMetricsLifecycle', {
      metricsUpdateInterval: null,
      topProcessesUpdateInterval: null,
      topProcessesInFlight: false,
      currentMetricsAgentId: null,
    });
    if (typeof window.initMetricsLifecycleState === 'function') {
      window.initMetricsLifecycleState(metricsLifecycleState);
    }
    const stopMetricsPolling = window.stopMetricsPollingLifecycle || function (stateAccess) {
      if (!stateAccess || typeof stateAccess.get !== 'function' || typeof stateAccess.set !== 'function') return;
      const metricsTimer = stateAccess.get('metricsUpdateInterval');
      const topTimer = stateAccess.get('topProcessesUpdateInterval');
      if (metricsTimer) { clearInterval(metricsTimer); stateAccess.set('metricsUpdateInterval', null); }
      if (topTimer) { clearInterval(topTimer); stateAccess.set('topProcessesUpdateInterval', null); }
    };
    let loadTimeframeSeconds = 3600;
    const METRICS_POLL_MS = 60_000; // 1 minute is enough for disk/mem/ips/top-procs/loadavg
    const TOP_PROCS_POLL_MS = 1_000; // top processes can change quickly

    function getMetricsCtx() {
      return {
        getMetricsLifecycleState: () => metricsLifecycleState,
        getLoadGraphData: () => loadGraphData,
        setLoadGraphData: (v) => { loadGraphData = v; return loadGraphData; },
        getLoadTimeframeSeconds: () => loadTimeframeSeconds,
      };
    }

    function initLoadTimeframeControls() {
      const sel = document.getElementById('load-timeframe');
      if (!sel) return;
      sel.addEventListener('change', async () => {
        const v = parseInt(sel.value, 10);
        if (!isNaN(v)) loadTimeframeSeconds = v;
        if (metricsLifecycleState.get('currentMetricsAgentId')) {
          loadGraphData = [];
          await loadHistoricalLoadData(metricsLifecycleState.get('currentMetricsAgentId'));
        }
      });
      // Ensure it matches initial value
      const v = parseInt(sel.value, 10);
      if (!isNaN(v)) loadTimeframeSeconds = v;
    }

    // Hosts + filtering state
    const hostFilterSelectionState = createUiStateAccess('hostFilterSelection', {
      allHosts: [],
      hostSearchQuery: '',
      labelEnvFilter: '',
      labelRoleFilter: '',
      vulnFilteredAgentIds: null,
      selectedAgentIds: new Set(),
      lastRenderedAgentIds: [],
    });
    const hostFilterSelectionDefaults = (typeof window.initHostFilterSelectionState === 'function')
      ? window.initHostFilterSelectionState(hostFilterSelectionState)
      : {
        allHosts: [],
        hostSearchQuery: '',
        labelEnvFilter: '',
        labelRoleFilter: '',
        vulnFilteredAgentIds: null,
        selectedAgentIds: new Set(),
        lastRenderedAgentIds: [],
      };
    let allHosts = hostFilterSelectionDefaults.allHosts;
    let hostSearchQuery = hostFilterSelectionDefaults.hostSearchQuery;
    let labelEnvFilter = hostFilterSelectionDefaults.labelEnvFilter;
    let labelRoleFilter = hostFilterSelectionDefaults.labelRoleFilter;
    let vulnFilteredAgentIds = hostFilterSelectionDefaults.vulnFilteredAgentIds; // Set<string> or null
    let selectedAgentIds = hostFilterSelectionDefaults.selectedAgentIds;
    let lastRenderedAgentIds = hostFilterSelectionDefaults.lastRenderedAgentIds; // string[]

    function syncHostFilterSelectionState(key, value) {
      hostFilterSelectionState.set(key, value);
      return value;
    }
    // Will be initialized in initHostFilters(); renderHosts() calls this.
    let updateUpgradeControlsFn = () => { };
    let lastPkgVerification = null; // { packageName, vulnVersion, resultsByAgentId: { [aid]: { ok, found, version, status } } }
    let lastCveCheck = null; // { cve, resultsByAgentId: { [aid]: { affected, packages?: string[] } } }
    let lastCveAffectedAgentIds = []; // string[] for last CVE run (online hosts only)
    let lastCveUnionPackages = []; // string[] union of affected packages across affected hosts
    let selectedCvePackages = new Set(); // Set<string> selected in CVE package list
    let ansiblePlaybooks = [];

    // Packages workflow state
    let packagesSearchQuery = '';
    let packagesSearchTimer = null;
    let packagesUpdatesOnly = false;
    let pkgInteractiveTerminal = false;
    let selectedPackages = new Set();
    let currentPackageName = null;

    function getHostListCtx() {
      return {
        getAllHosts: () => allHosts,
        setAllHosts: (v) => { allHosts = syncHostFilterSelectionState('allHosts', v); return allHosts; },
        getHostSearchQuery: () => hostSearchQuery,
        getLabelEnvFilter: () => labelEnvFilter,
        setLabelEnvFilter: (v) => { labelEnvFilter = syncHostFilterSelectionState('labelEnvFilter', v); return labelEnvFilter; },
        getLabelRoleFilter: () => labelRoleFilter,
        setLabelRoleFilter: (v) => { labelRoleFilter = syncHostFilterSelectionState('labelRoleFilter', v); return labelRoleFilter; },
        getVulnFilteredAgentIds: () => vulnFilteredAgentIds,
        getSelectedAgentIds: () => selectedAgentIds,
        setLastRenderedAgentIds: (v) => { lastRenderedAgentIds = syncHostFilterSelectionState('lastRenderedAgentIds', v); return lastRenderedAgentIds; },
        getCurrentAgentId: () => currentAgentId,
        getLastPkgVerification: () => lastPkgVerification,
        selectHost,
        updateUpgradeControls: () => updateUpgradeControlsFn(),
        renderHosts: (hosts) => renderHosts(hosts),
      };
    }

    function rebuildLabelFilterOptions(hosts) {
      const mod = window.phase3HostList;
      if (mod && typeof mod.rebuildLabelFilterOptions === 'function') {
        if (Array.isArray(hosts)) getHostListCtx().setAllHosts(hosts);
        return mod.rebuildLabelFilterOptions(getHostListCtx());
      }
    }

    function applyHostFilters() {
      const listMod = window.phase3HostList;
      if (listMod && typeof listMod.applyHostFilters === 'function') {
        listMod.applyHostFilters(getHostListCtx());
      }
      const overviewMod = window.phase3Overview;
      if (overviewMod && typeof overviewMod.applyHostsTableFilters === 'function') {
        overviewMod.applyHostsTableFilters(getOverviewCtx());
      }
    }

    function renderHosts(hosts) {
      const mod = window.phase3HostList;
      if (mod && typeof mod.renderHosts === 'function') {
        return mod.renderHosts(getHostListCtx(), hosts);
      }
    }

    function clearCurrentHostSelection() {
      currentAgentId = null;
      metricsLifecycleState.set('currentMetricsAgentId', null);

      // Stop any existing metrics updates
      stopMetricsPolling(metricsLifecycleState);
      

      // Clear sidebar highlight
      document.querySelectorAll('.host-item').forEach(item => item.classList.remove('active'));

      // Hide host action buttons
      const hostActions = document.getElementById('host-actions');
      if (hostActions) hostActions.style.display = 'none';
      setHostActionActive(null);

      document.querySelectorAll('.host-context-name').forEach((el) => { el.textContent = '—'; });
      document.querySelectorAll('.host-context-ip').forEach((el) => { el.textContent = '—'; });

      // Reset the overview panel to fleet overview placeholder
      const placeholder = document.getElementById('server-info-placeholder');
      const header = document.getElementById('server-info-header');
      if (placeholder) placeholder.style.display = 'block';
      if (header) header.style.display = 'none';
      const driftSummary = document.getElementById('host-drift-summary');
      const driftList = document.getElementById('host-drift-list');
      const timelineList = document.getElementById('host-timeline-list');
      const timelineCount = document.getElementById('host-timeline-count');
      if (driftSummary) driftSummary.textContent = 'Select a host';
      if (driftList) driftList.innerHTML = '';
      hostDriftChecksCache = [];
      hostDriftCriticalOnly = false;
      hostTimelineItemsCache = [];
      if (timelineList) timelineList.innerHTML = '';
      if (timelineCount) timelineCount.textContent = '';
    }

    function selectHost(agentId, hostname) {
      const prevActiveTabId = document.querySelector('.tab-content-custom.active')?.id || 'server-info-tab';

      currentAgentId = agentId;

      // Reset per-host package filters so they don't leak across hosts
      packagesUpdatesOnly = false;
      const updatesOnlyEl = document.getElementById('packages-updates-only');
      if (updatesOnlyEl) updatesOnlyEl.checked = false;

      // Reset package selection when switching hosts (prevents stale selections and enables CVE pre-select)
      selectedPackages = new Set();
      const selPkgsEl = document.getElementById('select-visible-packages');
      if (selPkgsEl) selPkgsEl.checked = false;
      currentPackageName = null;
      const infoEl = document.getElementById('package-info');
      if (infoEl) infoEl.innerHTML = '';

      const hostActions = document.getElementById('host-actions');
      if (hostActions) hostActions.style.display = 'flex';

      // Stop any existing metrics updates
      stopMetricsPolling(metricsLifecycleState);

      // Clear load graph data when switching hosts
      loadGraphData = [];

      // Update active host in sidebar
      document.querySelectorAll('.host-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.agentId === agentId) {
          item.classList.add('active');
        }
      });

      // Update header content for the host overview panel
      document.getElementById('server-info-placeholder').style.display = 'none';
      document.getElementById('server-info-header').style.display = 'block';
      document.getElementById('server-info-hostname').textContent = hostname;

      const hostObj = (allHosts || []).find(h => h.agent_id === agentId);
      void loadHostDrift(agentId);
      void loadHostTimeline(agentId);
      const hostDisplayName = (hostObj?.hostname || hostname || agentId || '—');
      const hostIp = (hostObj?.ip_address || hostObj?.fqdn || 'n/a');
      document.querySelectorAll('.host-context-name').forEach((el) => { el.textContent = hostDisplayName; });
      document.querySelectorAll('.host-context-ip').forEach((el) => { el.textContent = hostIp; });

      const detailsEl = document.getElementById('server-info-details');
      if (detailsEl) {
        const agentText = hostObj?.agent_id ? escapeHtml(hostObj.agent_id) : 'n/a';
        const osParts = [];
        if (hostObj?.os_id) osParts.push(String(hostObj.os_id));
        if (hostObj?.os_version) osParts.push(String(hostObj.os_version));
        const osText = osParts.length ? escapeHtml(osParts.join(' ')) : 'n/a';
        detailsEl.innerHTML = `
          <span class="detail-pill">Agent ID: <code>${agentText}</code></span>
          <span class="detail-pill">OS: <code>${osText}</code></span>
        `;
      }

      const labelsEl = document.getElementById('server-info-labels');
      if (labelsEl) {
        const labels = (hostObj && hostObj.labels && typeof hostObj.labels === 'object') ? hostObj.labels : {};
        const env = labels.env ? String(labels.env) : '';
        const role = labels.role ? String(labels.role) : '';
        const parts = [];
        if (env) parts.push(`<span class="label-badge">env: <code>${escapeHtml(env)}</code></span>`);
        if (role) parts.push(`<span class="label-badge">role: <code>${escapeHtml(role)}</code></span>`);
        labelsEl.innerHTML = parts.length ? parts.join('') : `<span class="label-badge">env: <code>n/a</code></span><span class="label-badge">role: <code>n/a</code></span>`;
      }

      // Switch to the appropriate tab:
      // - If user is in Terminal/Users/Services/Packages, keep that tab when switching hosts.
      // - Otherwise default to the host overview (server-info-tab).
      const hostActionTabs = new Set(['terminal-tab', 'users-tab', 'services-tab', 'packages-tab']);
      const keepTabId = hostActionTabs.has(prevActiveTabId) ? prevActiveTabId : 'server-info-tab';

      document.querySelectorAll('.tab-content-custom, .tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById(keepTabId)?.classList.add('active');

      // Keep the host-action button highlight consistent
      if (keepTabId === 'terminal-tab') setHostActionActive('terminal');
      else if (keepTabId === 'users-tab') setHostActionActive('users');
      else if (keepTabId === 'services-tab') setHostActionActive('services');
      else if (keepTabId === 'packages-tab') setHostActionActive('packages');
      else setHostActionActive(null);

      // Refresh tab-specific content
      if (keepTabId === 'terminal-tab') {
        connect(currentAgentId);
        window.requestAnimationFrame(() => {
          fitTerminalViewport();
          setTimeout(fitTerminalViewport, 60);
        });
      } else if (keepTabId === 'users-tab') {
        loadUsers(currentAgentId);
      } else if (keepTabId === 'services-tab') {
        loadServices(currentAgentId);
      } else if (keepTabId === 'packages-tab') {
        loadPackages(currentAgentId);
        refreshPackagesNow(currentAgentId);
      } else {
        // Host overview: start metrics polling
        metricsLifecycleState.set('currentMetricsAgentId', agentId);
        loadHistoricalLoadData(agentId);
        loadMetrics(agentId);
        loadTopProcesses(agentId, true);

        metricsLifecycleState.set('metricsUpdateInterval', setInterval(() => {
          if (metricsLifecycleState.get('currentMetricsAgentId') === agentId &&
            document.getElementById('server-info-tab').classList.contains('active')) {
            loadMetrics(agentId, true);
          } else {
            stopMetricsPolling(metricsLifecycleState);
          }
        }, METRICS_POLL_MS));

        metricsLifecycleState.set('topProcessesUpdateInterval', setInterval(() => {
          if (metricsLifecycleState.get('currentMetricsAgentId') === agentId &&
            document.getElementById('server-info-tab').classList.contains('active')) {
            loadTopProcesses(agentId, true);
          } else {
            stopMetricsPolling(metricsLifecycleState);
          }
        }, TOP_PROCS_POLL_MS));
      }
    }

    async function loadTopProcesses(agentId, silent = true) {
      const mod = window.phase3Metrics;
      if (mod && typeof mod.loadTopProcesses === 'function') {
        return mod.loadTopProcesses(getMetricsCtx(), agentId, silent);
      }
    }

    async function loadMetrics(agentId, silent = false) {
      const mod = window.phase3Metrics;
      if (mod && typeof mod.loadMetrics === 'function') {
        return mod.loadMetrics(getMetricsCtx(), agentId, silent);
      }
    }

    function updateTopProcessesTable(processes) {
      const mod = window.phase3Metrics;
      if (mod && typeof mod.updateTopProcessesTable === 'function') {
        return mod.updateTopProcessesTable(processes);
      }
    }

    async function loadHistoricalLoadData(agentId) {
      const mod = window.phase3Metrics;
      if (mod && typeof mod.loadHistoricalLoadData === 'function') {
        return mod.loadHistoricalLoadData(getMetricsCtx(), agentId);
      }
    }

    function redrawLoadGraph() {
      const mod = window.phase3Metrics;
      if (mod && typeof mod.redrawLoadGraph === 'function') {
        return mod.redrawLoadGraph(getMetricsCtx());
      }
    }

    function updateLoadGraph(loadValue) {
      const mod = window.phase3Metrics;
      if (mod && typeof mod.updateLoadGraph === 'function') {
        return mod.updateLoadGraph(getMetricsCtx(), loadValue);
      }
    }

    let hostTimelineFilter = 'all';
    let hostTimelineItemsCache = [];
    let hostDriftCriticalOnly = false;
    let hostDriftChecksCache = [];

    function timelineJobCategory(it) {
      const jtRaw = String(it?.job_type || '').toLowerCase();
      const jt = jtRaw.replace(/[_\s]+/g, '-');

      const securityJobTypes = new Set([
        'cve-check',
        'security-campaign',
        'security-updates',
        'patch-security',
      ]);
      if (securityJobTypes.has(jt) || /(^|-)security(-|$)|(^|-)cve(-|$)/.test(jt)) return 'security';

      const serviceJobTypes = new Set([
        'query-services',
        'query-service-details',
        'service-restart',
        'service-start',
        'service-stop',
      ]);
      if (serviceJobTypes.has(jt) || /(^|-)service(s)?(-|$)/.test(jt)) return 'service';

      const packageJobTypes = new Set([
        'query-pkg-info',
        'query-pkg-updates',
        'query-pkg-version',
        'inventory-now',
        'pkg-upgrade',
        'dist-upgrade',
      ]);
      if (packageJobTypes.has(jt) || /(^|-)pkg(-|$)|(^|-)package(s)?(-|$)|(^|-)upgrade(-|$)|(^|-)inventory(-|$)/.test(jt)) return 'package';

      return 'other';
    }

    function timelineFilterMatch(it) {
      if (hostTimelineFilter === 'all') return true;
      const st = String(it?.status || '').toLowerCase();
      if (hostTimelineFilter === 'failed') return st === 'failed';
      return timelineJobCategory(it) === hostTimelineFilter;
    }

    function renderHostTimeline() {
      const el = document.getElementById('host-timeline-list');
      const countEl = document.getElementById('host-timeline-count');
      if (!el) return;

      ['all', 'failed', 'security', 'package', 'service'].forEach((k) => {
        const btn = document.getElementById(`timeline-filter-${k}`);
        if (!btn) return;
        btn.classList.toggle('btn-primary', hostTimelineFilter === k);
        if (btn.dataset.boundTimelineFilterRender !== '1') {
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            hostTimelineFilter = k;
            renderHostTimeline();
          });
          btn.dataset.boundTimelineFilterRender = '1';
        }
      });

      const allItems = (hostTimelineItemsCache || []);
      const items = allItems.filter(timelineFilterMatch);
      if (countEl) countEl.textContent = `(${items.length}/${allItems.length})`;
      if (!items.length) {
        el.innerHTML = '<div class="status-muted">No events for selected filter.</div>';
        return;
      }

      el.innerHTML = items.map((it) => {
        const t = it?.time ? new Date(it.time).toLocaleString() : 'n/a';
        const st = String(it?.status || 'unknown');
        const stClass = st === 'success' ? 'status-ok' : (st === 'failed' ? 'status-error' : 'status-muted');
        const jobType = escapeHtml(String(it?.job_type || 'job'));
        const jobId = escapeHtml(String(it?.job_id || ''));
        const stdout = it?.stdout ? `<a class="status-link" href="${escapeHtml(String(it.stdout))}" target="_blank" rel="noopener">stdout</a>` : '';
        const stderr = it?.stderr ? `<a class="status-link" href="${escapeHtml(String(it.stderr))}" target="_blank" rel="noopener">stderr</a>` : '';
        const links = [stdout, stderr].filter(Boolean).join(' • ');
        return `<div style="border:1px solid var(--border);border-radius:10px;padding:0.45rem 0.55rem;background:var(--panel-2);">
          <div style="display:flex;justify-content:space-between;gap:0.5rem;align-items:center;">
            <b>${jobType}</b>
            <span class="${stClass}" style="font-size:0.8rem;">${escapeHtml(st)}</span>
          </div>
          <div class="status-muted" style="font-size:0.82rem;margin-top:0.2rem;display:flex;justify-content:space-between;gap:0.5rem;align-items:center;flex-wrap:wrap;">
            <span>${escapeHtml(t)} • <code>${jobId}</code></span>
            <button class="btn" data-copy-job-id="${jobId}" type="button" style="padding:0.16rem 0.45rem;">Copy job id</button>
          </div>
          ${links ? `<div style="font-size:0.8rem;margin-top:0.2rem;">${links}</div>` : ''}
        </div>`;
      }).join('');

      el.querySelectorAll('button[data-copy-job-id]').forEach((btn) => {
        if (btn.dataset.boundCopyJobId === '1') return;
        btn.addEventListener('click', async (e) => {
          e.preventDefault();
          const id = btn.getAttribute('data-copy-job-id') || '';
          if (!id) return;
          try {
            if (navigator.clipboard && navigator.clipboard.writeText) {
              await navigator.clipboard.writeText(id);
            } else {
              const ta = document.createElement('textarea');
              ta.value = id;
              document.body.appendChild(ta);
              ta.select();
              document.execCommand('copy');
              document.body.removeChild(ta);
            }
            showToast('Job ID copied', 'success', 1800);
          } catch (_) {
            showToast('Failed to copy job ID', 'error', 2200);
          }
        });
        btn.dataset.boundCopyJobId = '1';
      });
    }

    async function loadHostTimeline(agentId) {
      const el = document.getElementById('host-timeline-list');
      if (!el || !agentId) return;
      el.innerHTML = '<div class="loading" style="padding:0.5rem;">Loading timeline…</div>';
      try {
        const r = await fetch(`/hosts/${encodeURIComponent(agentId)}/timeline?limit=50`, { credentials: 'include' });
        if (!r.ok) throw new Error(`timeline failed (${r.status})`);
        const d = await r.json();
        hostTimelineItemsCache = Array.isArray(d?.items) ? d.items : [];
        renderHostTimeline();
      } catch (e) {
        el.innerHTML = `<div class="error" style="margin:0;">${escapeHtml(e?.message || String(e))}</div>`;
      }
    }

    function renderHostDriftChecks() {
      const listEl = document.getElementById('host-drift-list');
      const toggleBtn = document.getElementById('host-drift-critical-only');
      if (!listEl) return;
      if (toggleBtn) toggleBtn.classList.toggle('btn-primary', hostDriftCriticalOnly);

      const checks = (hostDriftChecksCache || []).filter((c) => {
        if (!hostDriftCriticalOnly) return true;
        const sev = String(c?.severity || (String(c?.status || '') === 'pass' ? 'ok' : 'warn'));
        return sev === 'critical';
      });

      if (!checks.length) {
        listEl.innerHTML = '<div class="status-muted">No checks for selected filter.</div>';
        return;
      }

      listEl.innerHTML = checks.map((c) => {
        const sev = String(c?.severity || (String(c?.status || '') === 'pass' ? 'ok' : 'warn'));
        const sevClass = sev === 'critical' ? 'status-error' : (sev === 'warn' ? 'status-warn' : 'status-ok');
        return `<div style="display:flex;justify-content:space-between;gap:0.6rem;align-items:flex-start;">
          <div><b>${escapeHtml(String(c?.title || 'check'))}</b><div class="status-muted" style="font-size:0.82rem;">${escapeHtml(String(c?.detail || ''))}</div></div>
          <span class="${sevClass}" style="font-size:0.75rem;">${escapeHtml(sev)}</span>
        </div>`;
      }).join('');
    }

    async function loadHostDrift(agentId) {
      const sumEl = document.getElementById('host-drift-summary');
      const listEl = document.getElementById('host-drift-list');
      if (!sumEl || !listEl || !agentId) return;
      sumEl.textContent = 'Loading…';
      listEl.innerHTML = '';
      try {
        const r = await fetch(`/hosts/${encodeURIComponent(agentId)}/drift`, { credentials: 'include' });
        if (!r.ok) throw new Error(`drift failed (${r.status})`);
        const d = await r.json();
        const s = d?.summary || {};
        const lastRemAt = s.last_remediated_at ? new Date(s.last_remediated_at).toLocaleString() : null;
        const lastRemVia = s.last_remediated_via ? String(s.last_remediated_via).replace('-', ' ') : '';
        sumEl.innerHTML = `
          <div>Checks: <b>${s.checks_pass || 0}</b>/<b>${s.checks_total || 0}</b> pass • <b>${s.checks_warn || 0}</b> warnings</div>
          <div class="status-muted" style="font-size:0.82rem;margin-top:0.25rem;">Security updates: ${s.security_updates || 0} • All updates: ${s.all_updates || 0} • Failed runs 24h: ${s.failed_runs_24h || 0}</div>
          <div class="status-muted" style="font-size:0.82rem;margin-top:0.2rem;">Last remediated: ${lastRemAt ? `${escapeHtml(lastRemAt)}${lastRemVia ? ` via ${escapeHtml(lastRemVia)}` : ''}` : 'n/a'}</div>
          <div style="display:flex;gap:0.4rem;flex-wrap:wrap;margin-top:0.45rem;">
            <button class="btn" id="host-drift-refresh" type="button">Re-check</button>
            <button class="btn" id="host-drift-inventory" type="button">Inventory now</button>
            <button class="btn btn-primary" id="host-drift-security" type="button">Run security campaign</button>
            <button class="btn" id="host-drift-critical-only" type="button">Critical only</button>
          </div>
        `;

        document.getElementById('host-drift-refresh')?.addEventListener('click', (e) => {
          e.preventDefault();
          void loadHostDrift(agentId);
        });

        document.getElementById('host-drift-inventory')?.addEventListener('click', async (e) => {
          e.preventDefault();
          try {
            const rr = await fetch('/jobs/inventory-now', {
              method: 'POST',
              credentials: 'include',
              headers: { 'content-type': 'application/json' },
              body: JSON.stringify({ agent_ids: [agentId] }),
            });
            if (!rr.ok) throw new Error(`inventory-now failed (${rr.status})`);
            showToast('Inventory queued', 'success');
            setTimeout(() => { void loadHostDrift(agentId); }, 1500);
          } catch (err) {
            showToast(err.message || String(err), 'error');
          }
        });

        document.getElementById('host-drift-security')?.addEventListener('click', async (e) => {
          e.preventDefault();
          try {
            const now = new Date();
            const end = new Date(now.getTime() + 60 * 60 * 1000);
            const payload = {
              agent_ids: [agentId],
              window_start: now.toISOString(),
              window_end: end.toISOString(),
              concurrency: 1,
              reboot_if_needed: true,
              include_kernel: false,
            };
            const rr = await fetch('/patching/campaigns/security-updates', {
              method: 'POST',
              credentials: 'include',
              headers: { 'content-type': 'application/json' },
              body: JSON.stringify(payload),
            });
            if (!rr.ok) throw new Error(`security campaign failed (${rr.status})`);
            showToast('Security campaign queued for host', 'success');
            setTimeout(() => { void loadHostDrift(agentId); }, 1500);
          } catch (err) {
            showToast(err.message || String(err), 'error');
          }
        });

        document.getElementById('host-drift-critical-only')?.addEventListener('click', (e) => {
          e.preventDefault();
          hostDriftCriticalOnly = !hostDriftCriticalOnly;
          renderHostDriftChecks();
        });

        hostDriftChecksCache = Array.isArray(d?.checks) ? d.checks : [];
        renderHostDriftChecks();
      } catch (e) {
        sumEl.textContent = 'Drift unavailable';
        listEl.innerHTML = `<div class="error" style="margin:0;">${escapeHtml(e?.message || String(e))}</div>`;
      }
    }

    function initTimelineFilters() {
      ['all', 'failed', 'security', 'package', 'service'].forEach((k) => {
        const btn = document.getElementById(`timeline-filter-${k}`);
        if (!btn || btn.dataset.boundTimelineFilter === '1') return;
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          hostTimelineFilter = k;
          renderHostTimeline();
        });
        btn.dataset.boundTimelineFilter = '1';
      });
    }

    function showTerminal() {
      if (!currentAgentId) return;
      setHostActionActive('terminal');
      // Stop metrics updates when leaving server info view
      stopMetricsPolling(metricsLifecycleState);
      connect(currentAgentId);
      document.querySelectorAll('.tab-content-custom, .tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById('terminal-tab').classList.add('active');
      window.requestAnimationFrame(() => {
        fitTerminalViewport();
        setTimeout(fitTerminalViewport, 60);
      });
    }

    function showUsers() {
      if (!currentAgentId) return;
      setHostActionActive('users');
      // Stop metrics updates when leaving server info view
      stopMetricsPolling(metricsLifecycleState);
      document.querySelectorAll('.tab-content-custom, .tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById('users-tab').classList.add('active');
      loadUsers(currentAgentId);
    }

    function showServices() {
      if (!currentAgentId) return;
      setHostActionActive('services');
      // Stop metrics updates when leaving server info view
      stopMetricsPolling(metricsLifecycleState);
      document.querySelectorAll('.tab-content-custom, .tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById('services-tab').classList.add('active');
      loadServices(currentAgentId);
    }

    function showPackages() {
      if (!currentAgentId) return;
      setHostActionActive('packages');
      // Stop metrics updates when leaving server info view
      stopMetricsPolling(metricsLifecycleState);
      document.querySelectorAll('.tab-content-custom, .tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById('packages-tab').classList.add('active');
      // Load what's in DB immediately, then trigger an on-demand inventory refresh and reload.
      loadPackages(currentAgentId);
      refreshPackagesNow(currentAgentId);
    }

    function showServerInfo() {
      if (!currentAgentId) return;
      const hostObj = (allHosts || []).find(h => h.agent_id === currentAgentId);
      const hostname = hostObj?.hostname || currentAgentId;
      selectHost(currentAgentId, hostname);
    }

    async function loadAdminAudit(showToastOnManual = false) {
      const tbody = document.getElementById('admin-audit-table');
      const statusEl = document.getElementById('admin-audit-status');
      if (!tbody) return;

      const action = (document.getElementById('audit-filter-action')?.value || '').trim();
      const actor = (document.getElementById('audit-filter-actor')?.value || '').trim();

      try {
        setTableState(tbody, 6, 'loading', 'Loading…');
        if (statusEl) statusEl.textContent = '';

        const qs = new URLSearchParams();
        if (action) qs.set('action', action);
        if (actor) qs.set('actor', actor);
        qs.set('limit', '200');

        const r = await fetch(`/audit?${qs.toString()}`, { credentials: 'include' });
        const raw = await r.text();
        let d = null; try { d = raw ? JSON.parse(raw) : null; } catch {}
        if (!r.ok) throw new Error((d && (d.detail || d.error)) || raw || `audit fetch failed (${r.status})`);

        const items = (d && d.items) ? d.items : [];
        if (!items.length) {
          setTableState(tbody, 6, 'empty', 'No events');
          return;
        }
        tbody.innerHTML = '';
        for (const ev of items) {
          const tr = document.createElement('tr');
          const when = formatShortTime(ev.created_at || '');
          const who = String(ev.actor || '');
          const actionName = String(ev.action || '');
          const target = (ev.target_type || ev.target_name) ? `${String(ev.target_type||'')}:${String(ev.target_name||'')}` : '';
          const ip = String(ev.ip || '');
          const meta = safeJsonPreview(ev.meta || {}, 160);
          tr.innerHTML = `
            <td class="status-muted">${escapeHtml(when)}</td>
            <td><a href="#" data-audit-id="${escapeHtml(String(ev.id||''))}" style="text-decoration:underline;color:inherit;"><code>${escapeHtml(actionName)}</code></a></td>
            <td>${escapeHtml(who)}</td>
            <td class="status-muted">${escapeHtml(target)}</td>
            <td class="status-muted"><code>${escapeHtml(ip)}</code></td>
            <td class="status-muted"><code>${escapeHtml(meta)}</code></td>
          `;
          tbody.appendChild(tr);
        }

        tbody.querySelectorAll('a[data-audit-id]').forEach(a => {
          a.addEventListener('click', async (e) => {
            e.preventDefault();
            const id = a.getAttribute('data-audit-id') || '';
            if (!id) return;
            try {
              const r2 = await fetch(`/audit/${encodeURIComponent(id)}`, { credentials: 'include' });
              const raw2 = await r2.text();
              let d2 = null; try { d2 = raw2 ? JSON.parse(raw2) : null; } catch {}
              if (!r2.ok) throw new Error((d2 && (d2.detail||d2.error)) || raw2 || 'Audit event load failed');

              const pretty = JSON.stringify(d2.meta || {}, null, 2);

              // Show in a large, copyable modal instead of alert().
              const modal = document.getElementById('audit-detail-modal');
              const titleEl = document.getElementById('audit-detail-modal-title');
              const outEl = document.getElementById('audit-detail-modal-output');
              const metaEl = document.getElementById('audit-detail-modal-meta');
              if (modal && titleEl && outEl && metaEl) {
                titleEl.textContent = `Audit event: ${d2.action || ''}`;
                metaEl.textContent = `Time: ${d2.created_at || ''} · Actor: ${d2.actor || ''} · Target: ${(d2.target_type||'')}:${(d2.target_name||'')} · IP: ${d2.ip || ''}`;
                outEl.value = pretty;
                modal.hidden = false;
                modal.classList.add('open');
                modal.setAttribute('aria-hidden', 'false');
              } else {
                alert(
                  `Audit event\n\n` +
                  `Time: ${d2.created_at || ''}\n` +
                  `Action: ${d2.action || ''}\n` +
                  `Actor: ${d2.actor || ''}\n` +
                  `Target: ${(d2.target_type||'')}:${(d2.target_name||'')}\n` +
                  `IP: ${d2.ip || ''}\n\n` +
                  `Meta:\n${pretty}`
                );
              }
            } catch (err) {
              showToast(err.message || String(err), 'error', 5000);
            }
          });
        });

        if (showToastOnManual) showToast('Audit refreshed', 'success');
      } catch (e) {
        setTableState(tbody, 6, 'error', e.message || String(e));
        if (statusEl) statusEl.textContent = e.message;
        if (showToastOnManual) showToast(e.message, 'error');
      }
    }

    async function loadAdminUsers(showToastOnManual = false) {
      const tbody = document.getElementById('admin-users-table');
      const statusEl = document.getElementById('admin-users-status');
      if (!tbody) return;

      try {
        setTableState(tbody, 7, 'loading', 'Loading…');
        if (statusEl) statusEl.textContent = '';
        const r = await fetch('/auth/admin/users', { credentials: 'include' });
        const raw = await r.text();
        let d = null; try { d = raw ? JSON.parse(raw) : null; } catch {}
        if (!r.ok) throw new Error((d && (d.detail || d.error)) || raw || `users list failed (${r.status})`);

        const items = (d && d.items) ? d.items : [];
        if (!items.length) {
          setTableState(tbody, 7, 'empty', 'No users');
          return;
        }
        tbody.innerHTML = '';
        for (const u of items) {
          const tr = document.createElement('tr');
          const role = String(u.role || 'operator');
          const active = (u.active === false) ? 'no' : 'yes';
          const mfa = u.mfa_enabled ? 'enabled' : 'off';
          const created = formatShortTime(u.created_at || '');
          const uname = String(u.username || '');
          const bootstrap = String(adminUsername || 'admin');
          const canToggleActive = !!(currentPermissions && currentPermissions.can_delete_app_users) && uname && uname !== bootstrap && uname !== currentUsername;
          const canResetMfa = !!(currentPermissions && currentPermissions.can_manage_users) && uname && uname !== currentUsername;
          const isActive = (u.active !== false);

          tr.innerHTML = `
            <td><code>${escapeHtml(uname)}</code></td>
            <td>${escapeHtml(role)}</td>
            <td>${escapeHtml(active)}</td>
            <td>${escapeHtml(mfa)}</td>
            <td class="status-muted">${escapeHtml(created)}</td>
            <td>
              <textarea class="admin-input" rows="2" data-user-scope="${escapeHtml(uname)}" placeholder='[{"env":["prod"],"team":["core"]}]' style="min-width:260px;"></textarea>
              <div style="margin-top:0.35rem;"><button class="btn" data-user-scope-save="${escapeHtml(uname)}">Save scope</button></div>
            </td>
            <td style="text-align:right;white-space:nowrap;display:flex;gap:0.4rem;justify-content:flex-end;">
              <button class="btn" data-user-mfa-reset="${escapeHtml(uname)}" ${canResetMfa ? '' : 'disabled'} title="${canResetMfa ? 'Reset MFA for this user' : 'Cannot reset your own MFA here'}">Reset MFA</button>
              <button class="btn" data-user-toggle-active="${escapeHtml(uname)}" data-user-active="${isActive ? '1' : '0'}" ${canToggleActive ? '' : 'disabled'} title="${canToggleActive ? (isActive ? 'Deactivate user' : 'Activate user') : 'Cannot change this user'}">${isActive ? 'Deactivate' : 'Activate'}</button>
            </td>
          `;
          tbody.appendChild(tr);
        }

        // Load per-user scope selectors into textareas.
        const scopeAreas = Array.from(tbody.querySelectorAll('textarea[data-user-scope]'));
        for (const ta of scopeAreas) {
          const uname = ta.getAttribute('data-user-scope') || '';
          if (!uname) continue;
          try {
            const rs = await fetch(`/auth/admin/users/${encodeURIComponent(uname)}/scopes`, { credentials: 'include' });
            if (!rs.ok) continue;
            const ds = await rs.json();
            ta.value = JSON.stringify((ds && ds.selectors) ? ds.selectors : [], null, 2);
          } catch {}
        }

        tbody.querySelectorAll('button[data-user-scope-save]').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.preventDefault();
            const uname = btn.getAttribute('data-user-scope-save') || '';
            const ta = tbody.querySelector(`textarea[data-user-scope="${CSS.escape(uname)}"]`);
            if (!uname || !ta) return;
            let selectors = [];
            try {
              const raw = (ta.value || '').trim() || '[]';
              const parsed = JSON.parse(raw);
              if (!Array.isArray(parsed)) throw new Error('Scope must be a JSON array');
              selectors = parsed;
            } catch (err) {
              showToast(`Invalid scope JSON for ${uname}: ${err.message || err}`, 'error', 5000);
              return;
            }
            try {
              const r3 = await fetch(`/auth/admin/users/${encodeURIComponent(uname)}/scopes`, {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': (getCookie('fleet_csrf') || '') },
                body: JSON.stringify({ selectors }),
              });
              const raw3 = await r3.text();
              let d3 = null; try { d3 = raw3 ? JSON.parse(raw3) : null; } catch {}
              if (!r3.ok) throw new Error((d3 && (d3.detail||d3.error)) || raw3 || 'Scope save failed');
              showToast(`Scope updated for ${uname}`, 'success');
              loadAdminAudit();
            } catch (err) {
              showToast(err.message || String(err), 'error', 5000);
            }
          });
        });

        tbody.querySelectorAll('button[data-user-mfa-reset]').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.preventDefault();
            const uname = btn.getAttribute('data-user-mfa-reset') || '';
            if (!uname) return;
            const reason = prompt(`Reset MFA for '${uname}'.\n\nOptional reason/ticket:`, '');
            if (reason === null) return;
            const ok = confirm(`Reset MFA for '${uname}' now?\n\nThis will revoke all active sessions and require re-enrollment at next login.`);
            if (!ok) return;
            try {
              const r2 = await fetch('/auth/mfa/admin/reset', {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': (getCookie('fleet_csrf') || '') },
                body: JSON.stringify({ username: uname, reason: reason || '' }),
              });
              const raw2 = await r2.text();
              let d2 = null; try { d2 = raw2 ? JSON.parse(raw2) : null; } catch {}
              if (!r2.ok) throw new Error((d2 && (d2.detail||d2.error)) || raw2 || 'MFA reset failed');
              showToast(`MFA reset for '${uname}' (sessions revoked: ${d2 && d2.sessions_revoked != null ? d2.sessions_revoked : 0})`, 'success');
              loadAdminUsers();
              loadAdminAudit();
            } catch (err) {
              showToast(err.message || String(err), 'error', 5000);
            }
          });
        });

        tbody.querySelectorAll('button[data-user-toggle-active]').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.preventDefault();
            const uname = btn.getAttribute('data-user-toggle-active') || '';
            const isActive = (btn.getAttribute('data-user-active') || '1') === '1';
            if (!uname) return;
            const action = isActive ? 'deactivate' : 'activate';
            const ok = confirm(`${isActive ? 'Deactivate' : 'Activate'} user '${uname}'?` + (isActive ? '\n\nThis will disable login and revoke sessions.' : ''));
            if (!ok) return;
            try {
              const endpoint = isActive ? `/auth/users/${encodeURIComponent(uname)}/delete` : `/auth/users/${encodeURIComponent(uname)}/activate`;
              const r2 = await fetch(endpoint, { method: 'POST', credentials: 'include', headers: { 'X-CSRF-Token': (getCookie('fleet_csrf')||'') } });
              const raw2 = await r2.text();
              let d2 = null; try { d2 = raw2 ? JSON.parse(raw2) : null; } catch {}
              if (!r2.ok) throw new Error((d2 && (d2.detail||d2.error)) || raw2 || `${action} failed`);
              showToast(`User '${uname}' ${isActive ? 'deactivated' : 'activated'}`, 'success');
              loadAdminUsers();
              loadAdminAudit();
            } catch (err) {
              showToast(err.message || String(err), 'error', 5000);
            }
          });
        });

        if (showToastOnManual) showToast('Users refreshed', 'success');
      } catch (e) {
        setTableState(tbody, 7, 'error', e.message || String(e));
        if (statusEl) statusEl.textContent = e.message;
        if (showToastOnManual) showToast(e.message, 'error');
      }
    }

    function initOidcMapPreview() {
      const runBtn = document.getElementById('admin-oidc-preview-run');
      const inEl = document.getElementById('admin-oidc-preview-input');
      const outEl = document.getElementById('admin-oidc-preview-output');
      const statusEl = document.getElementById('admin-oidc-preview-status');
      const card = document.getElementById('admin-oidc-map-preview-card');
      if (!runBtn || !inEl || !outEl || !statusEl || !card) return;

      card.style.display = 'block';

      runBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        let claims = {};
        try {
          const raw = (inEl.value || '').trim() || '{}';
          const parsed = JSON.parse(raw);
          if (!parsed || typeof parsed !== 'object' || Array.isArray(parsed)) throw new Error('Claims must be a JSON object');
          claims = parsed;
        } catch (err) {
          statusEl.textContent = err.message || String(err);
          showToast(statusEl.textContent, 'error');
          return;
        }

        runBtn.disabled = true;
        statusEl.textContent = 'Running preview…';
        try {
          const r = await fetch('/auth/admin/oidc/map-preview', {
            method: 'POST',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': (getCookie('fleet_csrf') || '') },
            body: JSON.stringify({ claims }),
          });
          const raw = await r.text();
          let d = null; try { d = raw ? JSON.parse(raw) : null; } catch {}
          if (!r.ok) throw new Error((d && (d.detail || d.error)) || raw || `Preview failed (${r.status})`);
          outEl.value = JSON.stringify(d || {}, null, 2);
          statusEl.textContent = 'Preview ready.';
        } catch (err) {
          statusEl.textContent = err.message || String(err);
          showToast(statusEl.textContent, 'error', 5000);
        } finally {
          runBtn.disabled = false;
        }
      });
    }

    async function loadAdminNotificationDedupe(showToastOnManual = false) {
      const card = document.getElementById('admin-dedupe-card');
      const tbody = document.getElementById('admin-dedupe-table');
      const statusEl = document.getElementById('admin-dedupe-status');
      if (!card || !tbody) return;

      const isAdmin = (currentPermissions && String(currentPermissions.role || '').toLowerCase() === 'admin') || !!(currentPermissions && currentPermissions.can_manage_users);
      if (!isAdmin) {
        card.style.display = 'none';
        return;
      }
      card.style.display = 'block';

      try {
        setTableState(tbody, 5, 'loading', 'Loading…');
        if (statusEl) statusEl.textContent = '';

        const kind = (document.getElementById('dedupe-filter-kind')?.value || '').trim();
        const minutes = (document.getElementById('dedupe-filter-minutes')?.value || '1440').trim();
        const qs = new URLSearchParams();
        qs.set('limit', '100');
        qs.set('minutes', minutes || '1440');
        if (kind) qs.set('kind', kind);

        const r = await fetch(`/dashboard/notifications/dedupe-state?${qs.toString()}`, { credentials: 'include' });
        const raw = await r.text();
        let d = null; try { d = raw ? JSON.parse(raw) : null; } catch {}
        if (!r.ok) throw new Error((d && (d.detail || d.error)) || raw || `dedupe state failed (${r.status})`);

        const items = (d && d.items) ? d.items : [];
        if (!items.length) {
          setTableState(tbody, 5, 'empty', 'No dedupe entries in selected window');
          if (showToastOnManual) showToast('Dedupe state refreshed', 'success');
          return;
        }

        tbody.innerHTML = '';
        for (const it of items) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="status-muted">${escapeHtml(formatShortTime(it.last_emitted_at || ''))}</td>
            <td><code>${escapeHtml(it.kind || '')}</code></td>
            <td>${escapeHtml(it.severity || '')}</td>
            <td style="white-space:normal;overflow-wrap:anywhere;word-break:break-word;"><code>${escapeHtml(it.dedupe_key || '')}</code></td>
            <td style="color:var(--muted-2);white-space:normal;overflow-wrap:anywhere;word-break:break-word;">${escapeHtml(it.last_title || '')}</td>
          `;
          tbody.appendChild(tr);
        }

        if (showToastOnManual) showToast('Dedupe state refreshed', 'success');
      } catch (e) {
        setTableState(tbody, 5, 'error', e.message || String(e));
        if (statusEl) statusEl.textContent = e.message || String(e);
        if (showToastOnManual) showToast(e.message || String(e), 'error');
      }
    }

    async function refreshApprovalsIndicator() {
      const badge = document.getElementById('approvals-badge');
      if (!badge) return;
      const isAdmin = (currentPermissions && String(currentPermissions.role || '').toLowerCase() === 'admin') || !!(currentPermissions && currentPermissions.can_manage_users);
      if (!isAdmin) {
        badge.style.display = 'none';
        return;
      }
      try {
        const r = await fetch('/approvals/admin/pending', { credentials: 'include' });
        if (!r.ok) throw new Error(`approvals failed (${r.status})`);
        const d = await r.json();
        const count = ((d && d.items) ? d.items : []).length;
        badge.style.display = count > 0 ? 'inline' : 'none';
        badge.textContent = count > 0 ? `⚠${count > 9 ? '9+' : count}` : '⚠';
      } catch (_) {
        badge.style.display = 'none';
      }
    }

    async function loadAdminApprovals(showToastOnManual = false) {
      const card = document.getElementById('admin-approvals-card');
      const tbody = document.getElementById('admin-approvals-table');
      const statusEl = document.getElementById('admin-approvals-status');
      if (!card || !tbody) return;

      const isAdmin = (currentPermissions && String(currentPermissions.role || '').toLowerCase() === 'admin') || !!(currentPermissions && currentPermissions.can_manage_users);
      if (!isAdmin) {
        card.style.display = 'none';
        await refreshApprovalsIndicator();
        return;
      }
      card.style.display = 'block';

      try {
        setTableState(tbody, 5, 'loading', 'Loading…');
        if (statusEl) statusEl.textContent = '';

        const filterAction = (document.getElementById('approvals-filter-action')?.value || '').trim().toLowerCase();
        const filterRequester = (document.getElementById('approvals-filter-requester')?.value || '').trim().toLowerCase();
        const ageMins = parseInt((document.getElementById('approvals-filter-age')?.value || '').trim(), 10);
        const mode = (document.getElementById('approvals-filter-mode')?.value || 'pending').trim();
        const sortMode = (document.getElementById('approvals-filter-sort')?.value || 'created_desc').trim();
        const nowMs = Date.now();

        const qs = new URLSearchParams();
        qs.set('mode', mode === 'recent' ? 'recent' : 'pending');
        qs.set('hours', '24');
        const r = await fetch(`/approvals/admin/pending?${qs.toString()}`, { credentials: 'include' });
        const raw = await r.text();
        let d = null; try { d = raw ? JSON.parse(raw) : null; } catch {}
        if (!r.ok) throw new Error((d && (d.detail || d.error)) || raw || `approvals failed (${r.status})`);

        const items = (d && d.items) ? d.items : [];

        const filtered = items.filter((it) => {
          const act = String(it?.action || '').toLowerCase();
          const usr = String(it?.user || '').toLowerCase();
          if (filterAction && !act.includes(filterAction)) return false;
          if (filterRequester && !usr.includes(filterRequester)) return false;
          if (!Number.isNaN(ageMins) && ageMins > 0) {
            const ts = Date.parse(String(it?.created_at || ''));
            if (!Number.isNaN(ts)) {
              const age = (nowMs - ts) / 60000;
              if (age > ageMins) return false;
            }
          }
          return true;
        });

        filtered.sort((a, b) => {
          if (sortMode === 'created_asc') return Date.parse(String(a?.created_at || '')) - Date.parse(String(b?.created_at || ''));
          if (sortMode === 'action_asc') return String(a?.action || '').localeCompare(String(b?.action || ''));
          if (sortMode === 'requester_asc') return String(a?.user || '').localeCompare(String(b?.user || ''));
          return Date.parse(String(b?.created_at || '')) - Date.parse(String(a?.created_at || ''));
        });

        if (!filtered.length) {
          const emptyBase = (mode === 'recent') ? 'No approvals in last 24h' : 'No pending approvals';
          setTableState(tbody, 5, 'empty', items.length ? 'No requests match filters' : emptyBase);
          await refreshApprovalsIndicator();
          if (showToastOnManual) showToast('Approvals refreshed', 'success');
          return;
        }

        tbody.innerHTML = '';
        for (const it of filtered) {
          const payload = (it && typeof it.payload === 'object' && it.payload) ? it.payload : {};
          const targets = Array.isArray(payload.agent_ids) ? payload.agent_ids : [];
          const targetLabel = targets.length ? `${targets.slice(0, 3).join(', ')}${targets.length > 3 ? ` (+${targets.length - 3})` : ''}` : 'selector-based';
          const tr = document.createElement('tr');
          const isPending = String(it?.status || '') === 'pending';
          const execRef = String(it?.execution_ref || '');
          const feedback = String((approvalActionFeedback && approvalActionFeedback[it.id]) || '');
          tr.innerHTML = `
            <td class="status-muted">${escapeHtml(formatShortTime(it.created_at))}</td>
            <td>${escapeHtml(it.user || '')}<div class="status-muted" style="font-size:0.8rem;">${escapeHtml(String(it?.status || ''))}</div></td>
            <td><code>${escapeHtml(it.action || '')}</code>${execRef ? `<div class="status-muted" style="font-size:0.8rem;">${escapeHtml(execRef.slice(0, 16))}</div>` : ''}${feedback ? `<div class="status-ok" style="font-size:0.78rem;max-width:260px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${escapeHtml(feedback)}">${escapeHtml(feedback)}</div>` : ''}</td>
            <td title="${escapeHtml(targets.join('\n'))}">${escapeHtml(targetLabel)}</td>
            <td style="text-align:right;white-space:nowrap;">
              <button class="btn" data-copy-id="${escapeHtml(it.id)}">Copy ID</button>
              <button class="btn" data-details-id="${escapeHtml(it.id)}">Details</button>
              <button class="btn btn-primary" data-approve-id="${escapeHtml(it.id)}" ${isPending ? '' : 'disabled'}>Approve</button>
              <button class="btn" data-reject-id="${escapeHtml(it.id)}" ${isPending ? '' : 'disabled'}>Reject</button>
            </td>
          `;
          tr.dataset.approvalPayload = JSON.stringify(it || {});
          tbody.appendChild(tr);
        }

        tbody.querySelectorAll('button[data-copy-id]').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.preventDefault();
            const id = btn.getAttribute('data-copy-id') || '';
            if (!id) return;
            try {
              await navigator.clipboard.writeText(id);
              showToast('Request ID copied', 'success');
            } catch {
              showToast('Copy failed', 'error');
            }
          });
        });

        tbody.querySelectorAll('button[data-details-id]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            const tr = btn.closest('tr');
            if (!tr) return;
            let row = null;
            try { row = JSON.parse(tr.dataset.approvalPayload || '{}'); } catch { row = null; }
            if (!row) return;
            const modal = document.getElementById('approval-detail-modal');
            const titleEl = document.getElementById('approval-detail-modal-title');
            const metaEl = document.getElementById('approval-detail-modal-meta');
            const outEl = document.getElementById('approval-detail-modal-output');
            if (!modal || !titleEl || !metaEl || !outEl) return;
            titleEl.textContent = `Approval request: ${row.action || ''}`;
            metaEl.textContent = `Requested: ${row.created_at || ''} · By: ${row.user || ''} · Status: ${row.status || ''} · ID: ${row.id || ''}`;
            outEl.value = JSON.stringify({
              request: {
                id: row.id || '',
                action: row.action || '',
                user: row.user || '',
                status: row.status || '',
                created_at: row.created_at || null,
                finished_at: row.finished_at || null,
                approved_by: row.approved_by || null,
                execution_ref: row.execution_ref || null,
                error: row.error || null,
              },
              payload: row.payload || {},
            }, null, 2);
            modal.hidden = false;
            modal.classList.add('open');
            modal.setAttribute('aria-hidden', 'false');
          });
        });

        tbody.querySelectorAll('button[data-approve-id]').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.preventDefault();
            const id = btn.getAttribute('data-approve-id');
            if (!id) return;
            const r2 = await fetch(`/approvals/admin/${encodeURIComponent(id)}/approve`, { method: 'POST', credentials: 'include' });
            const raw2 = await r2.text();
            let d2 = null; try { d2 = raw2 ? JSON.parse(raw2) : null; } catch {}
            if (!r2.ok) {
              const msg = (d2 && (d2.detail || d2.error)) || raw2 || 'Approve failed';
              return showToast(msg, 'error');
            }
            const msg = (d2 && d2.summary && d2.summary.message) ? d2.summary.message : 'Approved and executed';
            approvalActionFeedback[id] = msg;
            showToast(msg, 'success');
            loadAdminApprovals();
            loadAdminAudit();
            refreshApprovalsIndicator();
          });
        });

        tbody.querySelectorAll('button[data-reject-id]').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.preventDefault();
            const id = btn.getAttribute('data-reject-id');
            if (!id) return;
            const note = prompt('Reject note (optional):', '') || '';
            const r2 = await fetch(`/approvals/admin/${encodeURIComponent(id)}/reject`, {
              method: 'POST', credentials: 'include', headers: { 'content-type': 'application/json' }, body: JSON.stringify({ note })
            });
            const raw2 = await r2.text();
            let d2 = null; try { d2 = raw2 ? JSON.parse(raw2) : null; } catch {}
            if (!r2.ok) {
              const msg = (d2 && (d2.detail || d2.error)) || raw2 || 'Reject failed';
              return showToast(msg, 'error');
            }
            const msg = (d2 && d2.summary && d2.summary.message) ? d2.summary.message : 'Rejected';
            approvalActionFeedback[id] = msg;
            showToast(msg, 'success');
            loadAdminApprovals();
            loadAdminAudit();
            refreshApprovalsIndicator();
          });
        });

        await refreshApprovalsIndicator();
        if (showToastOnManual) showToast('Approvals refreshed', 'success');
      } catch (e) {
        setTableState(tbody, 5, 'error', e.message || String(e));
        if (statusEl) statusEl.textContent = e.message || String(e);
        if (showToastOnManual) showToast(e.message || String(e), 'error');
        await refreshApprovalsIndicator();
      }
    }

    function showAdminPage() {
      // Stop metrics updates when leaving server info view
      stopMetricsPolling(metricsLifecycleState);
      document.querySelectorAll('.tab-content-custom, .tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById('admin-tab').classList.add('active');
      loadAdminUsers();
      loadAdminApprovals();
      loadAdminNotificationDedupe();
      loadAdminAudit();
    }

    const setHostActionActive = window.setHostActionActive || function(action) {
      document.querySelectorAll('.host-action-btn').forEach(btn => btn.classList.remove('active'));
      const map = {
        terminal: 'host-action-terminal',
        users: 'host-action-users',
        services: 'host-action-services',
        packages: 'host-action-packages'
      };
      const id = map[action];
      const target = id ? document.getElementById(id) : null;
      if (target) target.classList.add('active');
    };

    function connect(agentId) {
      const run = window.connectTerminalSession;
      if (typeof run === 'function') {
        run({
          agentId,
          term,
          getWs: () => ws,
          setWs: (next) => { ws = next; },
          setCurrentAgentId: (next) => { currentAgentId = next; }
        });
        return;
      }

      currentAgentId = agentId;
      if (ws) { try { ws.close(); } catch { } }
      term.clear();
      term.write(`Connecting to ${agentId}...\r\n`);
      const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${location.host}/ws/terminal/${agentId}`);
      ws.binaryType = "arraybuffer";
    }

    async function loadHosts() {
      const hostsEl = document.getElementById('hosts');
      const mod = window.phase3HostList;
      try {
        if (mod && typeof mod.loadHosts === 'function') {
          await mod.loadHosts(getHostListCtx());
          return;
        }

        // Fallback path so UI doesn't stay stuck when module fails to load.
        console.error('[loadHosts] phase3HostList module missing; using inline fallback');
        const r = await fetch('/hosts?online_only=true', { credentials: 'include' });
        if (!r.ok) throw new Error(`hosts failed (${r.status})`);
        const items = await r.json();
        const hosts = Array.isArray(items) ? items : [];
        if (!hostsEl) return;
        if (!hosts.length) {
          hostsEl.innerHTML = '<div class="empty-state">No hosts found</div>';
          return;
        }
        hostsEl.innerHTML = hosts.map(h => `
          <div class="host-item">
            <div class="host-meta">
              <div class="host-row-top"><div class="host-name">${escapeHtml(h.hostname || h.agent_id || '')}</div></div>
              <div class="host-subline"><span class="host-subitem">${escapeHtml(h.agent_id || '')}</span></div>
            </div>
          </div>
        `).join('');
      } catch (e) {
        console.error('[loadHosts failed]', e);
        if (hostsEl) hostsEl.innerHTML = `<div class="error">Error loading hosts: ${escapeHtml(e?.message || String(e))}</div>`;
      }
    }

    function initHostFilters() {
      const mod = window.phase3HostFilters;
      if (!mod || typeof mod.initHostFilters !== 'function') return;

      const out = mod.initHostFilters({
        getState: () => ({
          allHosts,
          hostSearchQuery,
          labelEnvFilter,
          labelRoleFilter,
          vulnFilteredAgentIds,
          selectedAgentIds,
          lastRenderedAgentIds,
          lastPkgVerification,
          lastCveCheck,
          lastCveAffectedAgentIds,
          lastCveUnionPackages,
          selectedCvePackages,
        }),
        setState: (patch) => {
          if (!patch || typeof patch !== 'object') return;
          if (Object.prototype.hasOwnProperty.call(patch, 'allHosts')) allHosts = syncHostFilterSelectionState('allHosts', patch.allHosts || []);
          if (Object.prototype.hasOwnProperty.call(patch, 'hostSearchQuery')) hostSearchQuery = syncHostFilterSelectionState('hostSearchQuery', patch.hostSearchQuery || '');
          if (Object.prototype.hasOwnProperty.call(patch, 'labelEnvFilter')) labelEnvFilter = syncHostFilterSelectionState('labelEnvFilter', patch.labelEnvFilter || '');
          if (Object.prototype.hasOwnProperty.call(patch, 'labelRoleFilter')) labelRoleFilter = syncHostFilterSelectionState('labelRoleFilter', patch.labelRoleFilter || '');
          if (Object.prototype.hasOwnProperty.call(patch, 'vulnFilteredAgentIds')) vulnFilteredAgentIds = syncHostFilterSelectionState('vulnFilteredAgentIds', patch.vulnFilteredAgentIds);
          if (Object.prototype.hasOwnProperty.call(patch, 'selectedAgentIds')) selectedAgentIds = syncHostFilterSelectionState('selectedAgentIds', (patch.selectedAgentIds instanceof Set) ? patch.selectedAgentIds : new Set());
          if (Object.prototype.hasOwnProperty.call(patch, 'lastRenderedAgentIds')) lastRenderedAgentIds = syncHostFilterSelectionState('lastRenderedAgentIds', Array.isArray(patch.lastRenderedAgentIds) ? patch.lastRenderedAgentIds : []);
          if (Object.prototype.hasOwnProperty.call(patch, 'lastPkgVerification')) lastPkgVerification = patch.lastPkgVerification;
          if (Object.prototype.hasOwnProperty.call(patch, 'lastCveCheck')) lastCveCheck = patch.lastCveCheck;
          if (Object.prototype.hasOwnProperty.call(patch, 'lastCveAffectedAgentIds')) lastCveAffectedAgentIds = Array.isArray(patch.lastCveAffectedAgentIds) ? patch.lastCveAffectedAgentIds : [];
          if (Object.prototype.hasOwnProperty.call(patch, 'lastCveUnionPackages')) lastCveUnionPackages = Array.isArray(patch.lastCveUnionPackages) ? patch.lastCveUnionPackages : [];
          if (Object.prototype.hasOwnProperty.call(patch, 'selectedCvePackages')) selectedCvePackages = (patch.selectedCvePackages instanceof Set) ? patch.selectedCvePackages : new Set();
        },
        syncSelectionState: syncHostFilterSelectionState,
        applyHostFilters,
        pollJob: window.pollJob,
        escapeHtml,
        matchesGlob,
      });

      updateUpgradeControlsFn = (out && typeof out.updateUpgradeControls === 'function')
        ? out.updateUpgradeControls
        : (() => {});
    }

    function getHostWorkflowsCtx() {
      return {
        getCurrentPermissions: () => currentPermissions,
        getCurrentAgentId: () => currentAgentId,
      };
    }

    async function loadUsers(agentId) {
      const mod = window.phase3HostWorkflows;
      if (mod && typeof mod.loadUsers === 'function') {
        return mod.loadUsers(getHostWorkflowsCtx(), agentId);
      }
    }

    async function loadServices(agentId) {
      const mod = window.phase3HostWorkflows;
      if (mod && typeof mod.loadServices === 'function') {
        return mod.loadServices(getHostWorkflowsCtx(), agentId);
      }
    }

    async function waitForServicesToStabilize(agentId, targetServiceName = null) {
      const mod = window.phase3HostWorkflows;
      if (mod && typeof mod.waitForServicesToStabilize === 'function') {
        return mod.waitForServicesToStabilize(getHostWorkflowsCtx(), agentId, targetServiceName);
      }
    }

    async function controlService(agentId, serviceName, action) {
      const mod = window.phase3HostWorkflows;
      if (mod && typeof mod.controlService === 'function') {
        return mod.controlService(getHostWorkflowsCtx(), agentId, serviceName, action);
      }
    }

    window.controlService = controlService;

    async function controlUser(agentId, username, action) {
      const mod = window.phase3HostWorkflows;
      if (mod && typeof mod.controlUser === 'function') {
        return mod.controlUser(getHostWorkflowsCtx(), agentId, username, action);
      }
    }

    window.controlUser = controlUser;


    function getPackagesCtx() {
      return {
        getState: () => ({
          currentAgentId,
          packagesSearchQuery,
          packagesSearchTimer,
          packagesUpdatesOnly,
          pkgInteractiveTerminal,
          selectedPackages,
          currentPackageName,
        }),
        setState: (patch) => {
          if (!patch || typeof patch !== 'object') return;
          if (Object.prototype.hasOwnProperty.call(patch, 'packagesSearchQuery')) packagesSearchQuery = patch.packagesSearchQuery || '';
          if (Object.prototype.hasOwnProperty.call(patch, 'packagesSearchTimer')) packagesSearchTimer = patch.packagesSearchTimer || null;
          if (Object.prototype.hasOwnProperty.call(patch, 'packagesUpdatesOnly')) packagesUpdatesOnly = !!patch.packagesUpdatesOnly;
          if (Object.prototype.hasOwnProperty.call(patch, 'pkgInteractiveTerminal')) pkgInteractiveTerminal = !!patch.pkgInteractiveTerminal;
          if (Object.prototype.hasOwnProperty.call(patch, 'selectedPackages')) selectedPackages = (patch.selectedPackages instanceof Set) ? patch.selectedPackages : new Set();
          if (Object.prototype.hasOwnProperty.call(patch, 'currentPackageName')) currentPackageName = patch.currentPackageName || null;
        },
        runInteractivePackageCommand: (action, packages) => {
          if (!currentAgentId || !Array.isArray(packages) || !packages.length) return false;
          const esc = (s) => `'${String(s).replace(/'/g, `'"'"'`)}'`;
          const pkgArgs = packages.map(esc).join(' ');
          let cmd = '';
          if (action === 'upgrade') cmd = `sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --only-upgrade ${pkgArgs}`;
          else if (action === 'reinstall') cmd = `sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --reinstall ${pkgArgs}`;
          else if (action === 'remove') cmd = `sudo DEBIAN_FRONTEND=noninteractive apt-get remove -y ${pkgArgs}`;
          if (!cmd) return false;

          // Security: never collect terminal credentials in browser prompts.
          // Queue command, switch to terminal, and let user run it after login.
          pendingInteractivePackageCmd = cmd;
          updateTerminalPendingCmdButton();
          showTerminal();
          showToast('Terminal opened. Log in and click "Run pending package command".', 'info', 5000);
          return true;
        },
      };
    }

    function initPackagesSearch() {
      const mod = window.phase3Packages;
      if (mod && typeof mod.initPackagesSearch === 'function') {
        return mod.initPackagesSearch(getPackagesCtx());
      }
    }

    async function loadPackages(agentId) {
      const mod = window.phase3Packages;
      if (mod && typeof mod.loadPackages === 'function') {
        return mod.loadPackages(getPackagesCtx(), agentId);
      }
    }

    async function refreshPackagesNow(agentId) {
      const mod = window.phase3Packages;
      if (mod && typeof mod.refreshPackagesNow === 'function') {
        return mod.refreshPackagesNow(getPackagesCtx(), agentId);
      }
    }

    function getOverviewCtx() {
      return {
        formatShortTime,
        selectHost,
        openDiskModal,
        showServerInfo,
        showPackages,
        loadPackages,
        setPackagesUpdatesOnly: (v) => { packagesUpdatesOnly = !!v; },
        loadPendingUpdatesReport: (showToastOnManual = false) => loadPendingUpdatesReport(showToastOnManual),
        clearCurrentHostSelection,
        stopMetricsPolling: () => stopMetricsPolling(metricsLifecycleState),
        loadHostsTable,
        loadCronjobs,
        loadSshKeys,
        loadSshKeyRequests,
        maybeLoadSshKeyAdminQueue,
        loadAdminSshKeys,
        loadFleetOverview: (forceLive = false) => loadFleetOverview(forceLive),
        loadFailedRuns,
        loadHosts,
        getLastRenderedAgentIds: () => lastRenderedAgentIds,
        setLastRenderedAgentIds: (v) => { lastRenderedAgentIds = syncHostFilterSelectionState('lastRenderedAgentIds', Array.isArray(v) ? v : []); return lastRenderedAgentIds; },
        getHostSearchQuery: () => hostSearchQuery,
        getLabelEnvFilter: () => labelEnvFilter,
        getLabelRoleFilter: () => labelRoleFilter,
        getVulnFilteredAgentIds: () => vulnFilteredAgentIds,
        setAllHosts: (hosts) => {
          allHosts = syncHostFilterSelectionState('allHosts', Array.isArray(hosts) ? hosts : []);
          try {
            const hostListMod = window.phase3HostList;
            if (hostListMod && typeof hostListMod.rebuildLabelFilterOptions === 'function') {
              hostListMod.rebuildLabelFilterOptions(getHostListCtx());
            }
          } catch (_) { }
          return allHosts;
        },
      };
    }

    async function loadFleetOverview(forceLive = false) {
      const mod = window.phase3Overview;
      if (mod && typeof mod.loadFleetOverview === 'function') {
        return mod.loadFleetOverview(getOverviewCtx(), forceLive);
      }
    }

    async function loadFailedRuns(hours = 24, showToastOnManual = false) {
      const tbody = document.getElementById('overview-failed-runs');
      if (!tbody) return;
      try {
        setTableState(tbody, 5, 'loading', 'Loading…');
        const r = await fetch(`/dashboard/failed-runs?hours=${encodeURIComponent(hours)}&limit=200`, { credentials: 'include' });
        if (!r.ok) throw new Error(`failed-runs fetch failed (${r.status})`);
        const d = await r.json();
        const items = d?.items || [];
        if (!items.length) {
          setTableState(tbody, 5, 'empty', 'No failed runs 🎯');
          return;
        }
        tbody.innerHTML = '';
        for (const it of items) {
          const when = formatShortTime(it.finished_at);
          const host = it.agent_id || '–';
          const job = `${it.job_type || 'job'}${it.job_key ? ' • ' + it.job_key : ''}`.trim();
          const exit = (it.exit_code === null || it.exit_code === undefined) ? '–' : String(it.exit_code);
          const err = (it.error || (it.stderr || '').split('\n').slice(-1)[0] || '').trim();

          const tr = document.createElement('tr');
          tr.style.cursor = 'pointer';
          tr.innerHTML = `
            <td class="status-muted">${escapeHtml(when)}</td>
            <td><b>${escapeHtml(host)}</b></td>
            <td>${escapeHtml(job)}</td>
            <td style="text-align:right;">${escapeHtml(exit)}</td>
            <td class="status-error">${escapeHtml(err || 'failed')}</td>
          `;

          tr.addEventListener('click', () => {
            const detail = [
              `Host: ${host}`,
              `Job: ${job}`,
              it.finished_at ? `When: ${new Date(it.finished_at).toLocaleString()}` : '',
              (it.exit_code === null || it.exit_code === undefined) ? '' : `Exit: ${it.exit_code}`,
              '',
              '--- error ---',
              (it.error || ''),
              '',
              '--- stderr ---',
              (it.stderr || ''),
              '',
              '--- stdout ---',
              (it.stdout || ''),
            ].filter(Boolean).join('\n');
            alert(detail);
          });

          tbody.appendChild(tr);
        }
        if (showToastOnManual) showToast('Failed runs refreshed', 'success');
      } catch (e) {
        setTableState(tbody, 5, 'error', e.message || String(e));
        if (showToastOnManual) showToast(e.message, 'error');
      }
    }

    function formatShortTime(iso) {
      if (!iso) return '–';
      try {
        return new Date(iso).toLocaleString();
      } catch {
        return String(iso);
      }
    }

    async function loadHostsTable() {
      const mod = window.phase3Overview;
      if (mod && typeof mod.loadHostsTable === 'function') {
        return mod.loadHostsTable(getOverviewCtx());
      }
    }

    function getSelectedHostAgentIds() {
      const ids = [];
      document.querySelectorAll('.hosts-row-select:checked').forEach(cb => {
        const aid = cb.getAttribute('data-agent-id') || '';
        if (aid) ids.push(aid);
      });
      return ids;
    }

    function initHostsTableControls() {
      document.getElementById('hosts-reload')?.addEventListener('click', (e) => {
        e.preventDefault();
        loadHostsTable();
      });
      document.getElementById('hosts-sort')?.addEventListener('change', loadHostsTable);
      document.getElementById('hosts-order')?.addEventListener('change', loadHostsTable);

      document.getElementById('hosts-select-all')?.addEventListener('change', (e) => {
        const checked = !!e.target.checked;
        document.querySelectorAll('.hosts-row-select').forEach(cb => { cb.checked = checked; });
      });

      async function bulkPost(url, payload, okMsg) {
        const statusEl = document.getElementById('hosts-bulk-status');
        if (statusEl) statusEl.textContent = 'Working…';
        try {
          const r = await fetch(url, {
            method: 'POST',
            credentials: 'include',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify(payload),
          });
          if (!r.ok) throw new Error(`${url} failed (${r.status})`);
          const d = await r.json();
          showToast(okMsg, 'success');
          if (statusEl) statusEl.textContent = '';
          return d;
        } catch (e) {
          showToast(e.message, 'error');
          if (statusEl) statusEl.textContent = '';
        }
      }

      document.getElementById('hosts-bulk-inventory')?.addEventListener('click', async (e) => {
        e.preventDefault();
        const ids = getSelectedHostAgentIds();
        if (!ids.length) return showToast('Select hosts first', 'error');
        await bulkPost('/jobs/inventory-now', { agent_ids: ids }, `Triggered inventory for ${ids.length} hosts`);
      });

      document.getElementById('hosts-bulk-security')?.addEventListener('click', async (e) => {
        e.preventDefault();
        const ids = getSelectedHostAgentIds();
        if (!ids.length) return showToast('Select hosts first', 'error');
        const now = new Date();
        const end = new Date(now.getTime() + 60 * 60 * 1000);
        const payload = {
          agent_ids: ids,
          window_start: now.toISOString(),
          window_end: end.toISOString(),
          concurrency: 5,
          reboot_if_needed: true,
          include_kernel: false,
        };
        await bulkPost('/patching/campaigns/security-updates', payload, `Security campaign scheduled for ${ids.length} hosts`);
      });

      document.getElementById('hosts-bulk-dist')?.addEventListener('click', async (e) => {
        e.preventDefault();
        const ids = getSelectedHostAgentIds();
        if (!ids.length) return showToast('Select hosts first', 'error');
        await bulkPost('/jobs/dist-upgrade', { agent_ids: ids }, `dist-upgrade queued for ${ids.length} hosts`);
      });

      // Cleanup offline hosts
      document.getElementById('hosts-cleanup-offline')?.addEventListener('click', async (e) => {
        e.preventDefault();
        const minsStr = prompt('Delete hosts that have been offline for how many minutes?', '60');
        if (minsStr === null) return;
        const mins = parseInt((minsStr || '').trim(), 10);
        if (!Number.isFinite(mins) || mins < 1) {
          showToast('Enter a valid number of minutes (>= 1)', 'error');
          return;
        }

        // Dry run preview
        try {
          const previewResp = await fetch(`/hosts/cleanup-offline?older_than_minutes=${encodeURIComponent(mins)}&dry_run=true`, {
            method: 'POST',
            credentials: 'include'
          });
          if (!previewResp.ok) throw new Error(`preview failed (${previewResp.status})`);
          const preview = await previewResp.json();
          const n = preview?.count || 0;
          const agentIds = (preview?.agent_ids || []).slice(0, 12);
          const more = (preview?.agent_ids || []).length > 12 ? `\n… and ${(preview.agent_ids.length - 12)} more` : '';

          const msg = n
            ? `This will DELETE ${n} host(s) last seen before ${preview.cutoff}.\n\n${agentIds.join('\n')}${more}\n\nProceed?`
            : `No hosts are older than ${mins} minutes. (cutoff: ${preview.cutoff})`;

          if (!n) {
            showToast('No offline hosts to delete', 'success');
            return;
          }

          if (!confirm(msg)) return;

          const resp = await fetch(`/hosts/cleanup-offline?older_than_minutes=${encodeURIComponent(mins)}`, {
            method: 'POST',
            credentials: 'include'
          });
          if (!resp.ok) throw new Error(`cleanup failed (${resp.status})`);
          const out = await resp.json();
          showToast(`Deleted ${out?.deleted?.length || 0} host(s)`, 'success');

          // Reload lists
          await loadHosts();
          await loadHostsTable();
        } catch (err) {
          showToast(err.message || String(err), 'error');
        }
      });

      // Click-sort headers
      function setSort(key) {
        const sortSel = document.getElementById('hosts-sort');
        const orderSel = document.getElementById('hosts-order');
        if (!sortSel || !orderSel) return;
        const cur = sortSel.value;
        const curOrd = orderSel.value;
        if (cur === key) orderSel.value = (curOrd === 'asc') ? 'desc' : 'asc';
        else { sortSel.value = key; orderSel.value = 'asc'; }
        updateHostsSortIndicators(sortSel.value, orderSel.value);
        loadHostsTable();
      }
      const hostsSortSel = document.getElementById('hosts-sort');
      const hostsOrderSel = document.getElementById('hosts-order');
      updateHostsSortIndicators(hostsSortSel?.value || 'hostname', hostsOrderSel?.value || 'asc');
      bindSortableHeader('hosts-th-host', () => setSort('hostname'));
      bindSortableHeader('hosts-th-os', () => setSort('os_version'));
      bindSortableHeader('hosts-th-upd', () => setSort('updates'));
      bindSortableHeader('hosts-th-sec', () => setSort('security_updates'));
      bindSortableHeader('hosts-th-last', () => setSort('last_seen'));
    }

    async function loadPendingUpdatesReport(showToastOnManual = false) {
      const mod = window.phase3Overview;
      if (mod && typeof mod.loadPendingUpdatesReport === 'function') {
        return mod.loadPendingUpdatesReport(getOverviewCtx(), showToastOnManual);
      }
    }

    function initFleetOverviewControls() {
      const mod = window.phase3Overview;
      if (mod && typeof mod.initFleetOverviewControls === 'function') {
        return mod.initFleetOverviewControls(getOverviewCtx());
      }
    }

    

    async function loadCronjobs(showToastOnManual = false) {
      const tbody = document.getElementById('cronjobs-table');
      if (!tbody) return;
      try {
        setTableState(tbody, 6, 'loading', 'Loading…');
        const r = await fetch('/cronjobs', { credentials: 'include' });
        if (!r.ok) throw new Error(`cronjobs failed (${r.status})`);
        const d = await r.json();
        const items = d?.items || [];
        if (!items.length) {
          setTableState(tbody, 6, 'empty', 'No cronjobs yet');
          return;
        }
        tbody.innerHTML = '';
        for (const it of items) {
          const tr = document.createElement('tr');
          const when = formatShortTime(it.run_at);
          const targets = Array.isArray(it.selector?.agent_ids) ? it.selector.agent_ids.length : '–';
          const status = it.status || '–';
          tr.innerHTML = `
            <td class="status-muted">${escapeHtml(when)}</td>
            <td>${escapeHtml(it.name || '')}</td>
            <td><code>${escapeHtml(it.action || '')}</code></td>
            <td>${escapeHtml(String(targets))}</td>
            <td>${escapeHtml(status)}</td>
            <td style="text-align:right;">
              ${(() => {
                const jk = it.latest_run?.job_key || '';
                if (jk && !jk.startsWith('patch-campaign:')) {
                  return `<a class="btn" href="/jobs/${encodeURIComponent(jk)}/logs.zip" target="_blank" rel="noopener">Download logs</a>`;
                }
                return '';
              })()}
              ${status === 'scheduled' ? ` <button class="btn" data-cancel-id="${escapeHtml(it.id)}">Cancel</button>` : ''}
            </td>
          `;
          tbody.appendChild(tr);
        }
        // wire cancel buttons
        tbody.querySelectorAll('button[data-cancel-id]').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.preventDefault();
            const id = btn.getAttribute('data-cancel-id');
            if (!id) return;
            const r2 = await fetch(`/cronjobs/${encodeURIComponent(id)}/cancel`, { method: 'POST', credentials: 'include' });
            if (!r2.ok) return showToast('Cancel failed', 'error');
            showToast('Cronjob canceled', 'success');
            loadCronjobs();
          });
        });
        if (showToastOnManual) showToast('Cronjobs refreshed', 'success');
      } catch (e) {
        setTableState(tbody, 6, 'error', e.message || String(e));
        if (showToastOnManual) showToast(e.message, 'error');
      }
    }


    // Cronjobs host picker (separate from Hosts tab selection)
    const cronUiState = createUiStateAccess('cronHostPicker', { selectedAgentIds: new Set() });
    const cronUiDefaults = (typeof window.initCronHostPickerState === 'function')
      ? window.initCronHostPickerState(cronUiState)
      : { selectedAgentIds: (cronUiState.get('selectedAgentIds') instanceof Set) ? cronUiState.get('selectedAgentIds') : new Set() };

    function getCronSelectedAgentIds() {
      return cronUiState.get('selectedAgentIds', cronUiDefaults.selectedAgentIds);
    }

    function setCronSelectedAgentIds(next) {
      return cronUiState.set('selectedAgentIds', (next instanceof Set) ? next : new Set());
    }

    function setCronHostsPanelVisible(visible) {
      const panel = document.getElementById('cron-hosts-panel');
      if (!panel) return;
      panel.style.display = visible ? 'block' : 'none';
    }

    function renderCronHostsList() {
      const listEl = document.getElementById('cron-hosts-list');
      const countEl = document.getElementById('cron-hosts-count');
      if (!listEl) return;

      const selectedAgentIds = getCronSelectedAgentIds();
      const q = (document.getElementById('cron-hosts-search')?.value || '').trim().toLowerCase();
      const hosts = (allHosts || []).slice();

      listEl.innerHTML = '';
      if (!hosts.length) {
        listEl.innerHTML = '<div class="empty-state" style="padding:0.75rem;">No hosts loaded yet.</div>';
        if (countEl) countEl.textContent = String(selectedAgentIds.size);
        return;
      }

      for (const h of hosts) {
        const aid = h.agent_id || '';
        const name = h.hostname || aid;
        const ip = h.ip_address || '';
        const os = `${h.os_id || ''} ${h.os_version || ''}`.trim();
        const hay = `${name} ${aid} ${ip} ${os}`.toLowerCase();
        if (q && !hay.includes(q)) continue;

        const row = document.createElement('label');
        row.style.display = 'flex';
        row.style.alignItems = 'center';
        row.style.justifyContent = 'space-between';
        row.style.gap = '0.75rem';
        row.style.padding = '0.5rem 0.6rem';
        row.style.borderRadius = '8px';
        row.style.cursor = 'pointer';
        row.style.background = 'transparent';

        const left = document.createElement('div');
        left.style.display = 'flex';
        left.style.flexDirection = 'column';
        left.style.gap = '0.1rem';

        const title = document.createElement('div');
        title.innerHTML = `<b>${escapeHtml(name)}</b> <span class="status-muted" style="font-size:0.85rem;">${escapeHtml(aid)}</span>`;
        const sub = document.createElement('div');
        sub.style.color = 'var(--muted-2)';
        sub.style.fontSize = '0.85rem';
        sub.textContent = ip ? ip : '';

        left.appendChild(title);
        if (ip) left.appendChild(sub);

        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = selectedAgentIds.has(aid);
        cb.addEventListener('change', () => {
          if (cb.checked) selectedAgentIds.add(aid);
          else selectedAgentIds.delete(aid);
          if (countEl) countEl.textContent = String(selectedAgentIds.size);
        });

        row.appendChild(left);
        row.appendChild(cb);
        row.addEventListener('mouseenter', () => { row.style.background = 'color-mix(in srgb, var(--panel) 55%, transparent)'; });
        row.addEventListener('mouseleave', () => { row.style.background = 'transparent'; });

        listEl.appendChild(row);
      }

      if (countEl) countEl.textContent = String(selectedAgentIds.size);
    }
    function initCronjobsControls() {

      setupCronScheduleUi();

      setupCronHostPickerControls({
        setPanelVisible: setCronHostsPanelVisible,
        renderList: renderCronHostsList,
        selectAll: () => {
          const selectedAgentIds = getCronSelectedAgentIds();
          (allHosts || []).forEach(h => { if (h.agent_id) selectedAgentIds.add(h.agent_id); });
        },
        clearSelection: () => {
          setCronSelectedAgentIds(new Set());
        },
      });

      const cronRefreshBtn = document.getElementById('cron-refresh');
      wireBusyClick(cronRefreshBtn, 'Refreshing…', async () => {
        await loadCronjobs(true);
      });

      const cronCreateBtn = document.getElementById('cron-create');
      cronCreateBtn?.addEventListener('click', async (e) => {
        e.preventDefault();
        await handleCronCreate({
          createBtn: cronCreateBtn,
          statusEl: document.getElementById('cron-create-status'),
          getSelectedAgentIds: () => Array.from(getCronSelectedAgentIds() || []),
          setPanelVisible: setCronHostsPanelVisible,
          renderList: renderCronHostsList,
          loadCronjobs: loadCronjobs,
          withBusyButton: withBusyButton,
        });
      });

      const fromFilterBtn = document.getElementById('cron-from-filter-open');
      const fromFilterRunNowBtn = document.getElementById('cron-from-filter-run-now');
      const runbookInventoryBtn = document.getElementById('runbook-inventory-now');
      const runbookSecurityBtn = document.getElementById('runbook-security-now');
      const runbookDistBtn = document.getElementById('runbook-dist-now');

      function getVisibleOrAllHostIds() {
        const visibleIds = Array.from(lastRenderedAgentIds || []);
        return visibleIds.length ? visibleIds : (allHosts || []).map(h => h.agent_id).filter(Boolean);
      }

      async function runImmediateForVisible(action) {
        const statusEl = document.getElementById('cron-from-filter-status');
        const ids = getVisibleOrAllHostIds();
        if (!ids.length) {
          if (statusEl) statusEl.textContent = 'No hosts available. Load hosts first.';
          return;
        }

        try {
          if (statusEl) statusEl.textContent = `Running ${action} for ${ids.length} hosts…`;
          let r = null;
          if (action === 'inventory-now') {
            r = await fetch('/jobs/inventory-now', { method: 'POST', credentials: 'include', headers: { 'content-type': 'application/json' }, body: JSON.stringify({ agent_ids: ids }) });
          } else if (action === 'security-campaign') {
            const now = new Date();
            const end = new Date(now.getTime() + 60 * 60 * 1000);
            r = await fetch('/patching/campaigns/security-updates', {
              method: 'POST', credentials: 'include', headers: { 'content-type': 'application/json' },
              body: JSON.stringify({ agent_ids: ids, window_start: now.toISOString(), window_end: end.toISOString(), concurrency: 5, reboot_if_needed: true, include_kernel: false })
            });
          } else {
            r = await fetch('/jobs/dist-upgrade', { method: 'POST', credentials: 'include', headers: { 'content-type': 'application/json' }, body: JSON.stringify({ agent_ids: ids }) });
          }

          if (!r || !r.ok) {
            const raw = r ? await r.text() : '';
            let detail = '';
            try { const j = raw ? JSON.parse(raw) : null; detail = j?.detail || j?.error || ''; } catch (_) { detail = ''; }
            throw new Error(detail || `request failed (${r ? r.status : 'n/a'})`);
          }

          let data = null;
          try { data = await r.json(); } catch (_) { data = null; }
          if (data && data.approval_required) {
            if (statusEl) statusEl.textContent = `Approval required: request ${data.request_id}`;
            showToast(`Approval required (${action}). Request: ${data.request_id}`, 'info', 5000);
            return;
          }

          if (statusEl) statusEl.textContent = `Triggered ${action} for ${ids.length} hosts.`;
          showToast(`Triggered ${action} for ${ids.length} hosts`, 'success');
        } catch (err) {
          const msg = (err && err.message) ? err.message : String(err);
          if (statusEl) statusEl.textContent = msg;
          showToast(msg, 'error');
        }
      }

      fromFilterBtn?.addEventListener('click', (e) => {
        e.preventDefault();
        const statusEl = document.getElementById('cron-from-filter-status');
        const action = document.getElementById('cron-from-filter-action')?.value || 'security-campaign';
        const schedule = document.getElementById('cron-from-filter-schedule')?.value || 'weekly-sun-0200';

        const ids = getVisibleOrAllHostIds();
        if (!ids.length) {
          if (statusEl) statusEl.textContent = 'No hosts available. Load hosts first.';
          return;
        }

        // Switch to cron tab and prefill fields.
        document.getElementById('nav-cronjobs')?.click();

        setCronSelectedAgentIds(new Set(ids));
        setCronHostsPanelVisible(true);
        renderCronHostsList();

        const actionEl = document.getElementById('cron-action');
        if (actionEl) actionEl.value = action;

        const nameEl = document.getElementById('cron-name');
        const env = (document.getElementById('label-env')?.value || '').trim();
        const role = (document.getElementById('label-role')?.value || '').trim();
        const search = (document.getElementById('host-search')?.value || '').trim();
        const scopeBits = [env ? `env:${env}` : '', role ? `role:${role}` : '', search ? `q:${search}` : ''].filter(Boolean).join(' ');
        if (nameEl) nameEl.value = `${action} (${scopeBits || 'visible hosts'})`;

        const kindEl = document.getElementById('cron-schedule-kind');
        const runAtEl = document.getElementById('cron-run-at');
        const timeEl = document.getElementById('cron-time');
        const weekdayEl = document.getElementById('cron-weekday');

        if (schedule === 'once-30m') {
          if (kindEl) kindEl.value = 'once';
          const dt = new Date(Date.now() + 30 * 60 * 1000);
          const yyyy = dt.getFullYear();
          const mm = String(dt.getMonth() + 1).padStart(2, '0');
          const dd = String(dt.getDate()).padStart(2, '0');
          const hh = String(dt.getHours()).padStart(2, '0');
          const mi = String(dt.getMinutes()).padStart(2, '0');
          if (runAtEl) runAtEl.value = `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
        } else if (schedule === 'daily-0600') {
          if (kindEl) kindEl.value = 'daily';
          if (timeEl) timeEl.value = '06:00';
        } else {
          if (kindEl) kindEl.value = 'weekly';
          if (weekdayEl) weekdayEl.value = '0'; // Sunday
          if (timeEl) timeEl.value = '02:00';
        }

        kindEl?.dispatchEvent(new Event('change'));
        if (statusEl) statusEl.textContent = `Prefilled cron with ${ids.length} hosts.`;
      });

      fromFilterRunNowBtn?.addEventListener('click', async (e) => {
        e.preventDefault();
        const action = document.getElementById('cron-from-filter-action')?.value || 'security-campaign';
        await runImmediateForVisible(action);
      });

      runbookInventoryBtn?.addEventListener('click', async (e) => { e.preventDefault(); await runImmediateForVisible('inventory-now'); });
      runbookSecurityBtn?.addEventListener('click', async (e) => { e.preventDefault(); await runImmediateForVisible('security-campaign'); });
      runbookDistBtn?.addEventListener('click', async (e) => { e.preventDefault(); await runImmediateForVisible('dist-upgrade'); });
    }

    // SSH Keys UI
    const sshUiState = createUiStateAccess('sshKeys', {
      keysCache: [],
      selectedKeyId: null,
      selectedAgentIds: new Set(),
    });
    const sshUiDefaults = (typeof window.initSshKeysUiState === 'function')
      ? window.initSshKeysUiState(sshUiState)
      : {
        keysCache: Array.isArray(sshUiState.get('keysCache')) ? sshUiState.get('keysCache') : [],
        selectedKeyId: sshUiState.get('selectedKeyId', null) || null,
        selectedAgentIds: (sshUiState.get('selectedAgentIds') instanceof Set) ? sshUiState.get('selectedAgentIds') : new Set(),
      };

    function getSshSelectedAgentIds() {
      return sshUiState.get('selectedAgentIds', sshUiDefaults.selectedAgentIds);
    }

    function setSshSelectedAgentIds(next) {
      return sshUiState.set('selectedAgentIds', (next instanceof Set) ? next : new Set());
    }

    function getSshSelectedKeyId() {
      return sshUiState.get('selectedKeyId', sshUiDefaults.selectedKeyId);
    }

    function setSshSelectedKeyId(next) {
      return sshUiState.set('selectedKeyId', next || null);
    }

    function getSshKeysCache() {
      return sshUiState.get('keysCache', sshUiDefaults.keysCache);
    }

    function setSshKeysCache(next) {
      return sshUiState.set('keysCache', Array.isArray(next) ? next : []);
    }

    function setSshHostsPanelVisible(v) {
      setPanelVisibleById('sshkey-hosts-panel', v);
    }

    function renderSshHostsList() {
      const selectedAgentIds = getSshSelectedAgentIds();
      const nextSelected = renderSshHostsListView({
        hosts: (allHosts || []),
        selectedAgentIds: selectedAgentIds,
        listId: 'sshkey-hosts-list',
        countId: 'sshkey-hosts-count',
        searchId: 'sshkey-hosts-search',
      }) || selectedAgentIds;
      setSshSelectedAgentIds(nextSelected);
    }

    async function loadSshKeys(showToastOnManual = false) {
      const tbody = document.getElementById('sshkeys-table');
      if (!tbody) return;
      try {
        setTableState(tbody, 4, 'loading', 'Loading…');
        const r = await fetch('/sshkeys', { credentials: 'include' });
        if (!r.ok) throw new Error(`sshkeys failed (${r.status})`);
        const d = await r.json();
        setSshKeysCache(d?.items || []);
        if (!getSshKeysCache().length) {
          setTableState(tbody, 4, 'empty', 'No keys yet');
          return;
        }
        tbody.innerHTML = '';
        for (const k of getSshKeysCache()) {
          const tr = document.createElement('tr');
          tr.style.cursor = 'pointer';
          const selectedKeyId = getSshSelectedKeyId();
          const isSel = (selectedKeyId && selectedKeyId === k.id);
          tr.innerHTML = `
            <td>${escapeHtml(k.name || '')}</td>
            <td><code>${escapeHtml(k.fingerprint || '')}</code></td>
            <td style="max-width:520px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"><code>${escapeHtml(k.public_key || '')}</code></td>
            <td style="text-align:right;"><button class="btn" data-revoke-id="${escapeHtml(k.id)}">Delete</button></td>
          `;
          if (isSel) tr.style.background = 'color-mix(in srgb, var(--primary) 12%, var(--panel))';
          tr.setAttribute('data-key-id', k.id);
          tr.addEventListener('click', (e) => {
            if ((e.target && e.target.tagName || '').toLowerCase() === 'button') return;
            setSshSelectedKeyId(k.id);
            // Highlight immediately.
            Array.from(tbody.querySelectorAll('tr[data-key-id]')).forEach(row => {
              const rowId = row.getAttribute('data-key-id');
              if (rowId && rowId === getSshSelectedKeyId()) {
                row.style.background = 'color-mix(in srgb, var(--primary) 12%, var(--panel))';
              } else {
                row.style.background = '';
              }
            });
          });
          tbody.appendChild(tr);
        }
        tbody.querySelectorAll('button[data-revoke-id]').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.preventDefault();
            const id = btn.getAttribute('data-revoke-id');
            if (!id) return;
            const r2 = await fetch(`/sshkeys/${encodeURIComponent(id)}`, { method: 'DELETE', credentials: 'include' });
            if (!r2.ok) return showToast('Delete failed', 'error');
            if (getSshSelectedKeyId() === id) setSshSelectedKeyId(null);
            showToast('Key deleted', 'success');
            loadSshKeys();
          });
        });
        if (showToastOnManual) showToast('SSH keys refreshed', 'success');
      } catch (e) {
        setTableState(tbody, 4, 'error', e.message || String(e));
        if (showToastOnManual) showToast(e.message, 'error');
      }
    }

    async function loadSshKeyRequests() {
      const tbody = document.getElementById('sshkey-requests-table');
      if (!tbody) return;
      try {
        setTableState(tbody, 6, 'loading', 'Loading…');
        const r = await fetch('/sshkeys/deploy-requests', { credentials: 'include' });
        if (!r.ok) throw new Error(`requests failed (${r.status})`);
        const d = await r.json();
        const items = d?.items || [];
        if (!items.length) {
          setTableState(tbody, 6, 'empty', 'No requests');
          return;
        }
        tbody.innerHTML = '';
        for (const it of items) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="status-muted">${escapeHtml(formatShortTime(it.created_at))}</td>
            <td><code>${escapeHtml(String(it.key_id || '')).slice(0,8)}</code></td>
            <td>${escapeHtml(String((it.agent_ids||[]).length))}</td>
            <td>${escapeHtml(it.status || '')}</td>
            <td>${escapeHtml(it.approved_by || '')}</td>
            <td class="status-error">${escapeHtml(it.error || '')}</td>
          `;
          tbody.appendChild(tr);
        }
      } catch (e) {
        setTableState(tbody, 6, 'error', e.message || String(e));
      }
    }

    async function loadAdminSshKeys() {
      const panel = document.getElementById('sshkey-admin-keys');
      const tbody = document.getElementById('sshkey-admin-keys-table');
      if (!panel || !tbody) return;

      const isAdmin = (currentPermissions && String(currentPermissions.role||'').toLowerCase() === 'admin') || !!currentPermissions.can_manage_users;
      if (!isAdmin) {
        panel.style.display = 'none';
        return;
      }
      panel.style.display = 'block';

      try {
        setTableState(tbody, 5, 'loading', 'Loading…');
        const r = await fetch('/sshkeys/admin/keys', { credentials: 'include' });
        if (!r.ok) throw new Error(`admin keys failed (${r.status})`);
        const d = await r.json();
        const items = d?.items || [];
        if (!items.length) {
          setTableState(tbody, 5, 'empty', 'No keys');
          return;
        }
        tbody.innerHTML = '';
        for (const k of items) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="status-muted">${escapeHtml(formatShortTime(k.created_at))}</td>
            <td>${escapeHtml(k.user_name || String(k.user_id||'').slice(0,8))}</td>
            <td>${escapeHtml(k.name || '')}</td>
            <td><code>${escapeHtml(k.fingerprint || '')}</code></td>
            <td style="max-width:520px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"><code>${escapeHtml(k.public_key || '')}</code></td>
          `;
          tbody.appendChild(tr);
        }
      } catch (e) {
        setTableState(tbody, 5, 'error', e.message || String(e));
      }
    }

    async function maybeLoadSshKeyAdminQueue() {
      const panel = document.getElementById('sshkey-admin-approvals');
      const tbody = document.getElementById('sshkey-admin-table');
      if (!panel || !tbody) return;
      // Only show for admin users
      const isAdmin = (currentPermissions && String(currentPermissions.role||'').toLowerCase() === 'admin') || !!currentPermissions.can_manage_users;
      if (!isAdmin) {
        panel.style.display = 'none';
        const indicator = document.getElementById('sshkeys-approval-indicator');
        if (indicator) indicator.style.display = 'none';
        return;
      }
      panel.style.display = 'block';
      try {
        const r = await fetch('/sshkeys/admin/deploy-requests', { credentials: 'include' });
        if (!r.ok) throw new Error(`admin queue failed (${r.status})`);
        const d = await r.json();
        const items = d?.items || [];

        const indicator = document.getElementById('sshkeys-approval-indicator');
        if (indicator) indicator.style.display = items.length ? 'inline' : 'none';

        if (!items.length) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;" class="status-muted">No pending approvals</td></tr>';
          return;
        }
        tbody.innerHTML = '';

        const itemsById = new Map();
        for (const it of items) itemsById.set(String(it.id), it);

        const targetsLabel = (it) => {
          const targets = it.targets || (it.agent_ids || []).map(aid => ({ agent_id: String(aid), hostname: String(aid) }));
          const names = targets.map(t => t.hostname || t.agent_id).filter(Boolean);
          const preview = names.slice(0, 3).join(', ');
          const more = names.length > 3 ? ` (+${names.length - 3} more)` : '';
          return { text: preview + more, title: names.join('\n') };
        };

        for (const it of items) {
          const tr = document.createElement('tr');
          const t = targetsLabel(it);
          tr.innerHTML = `
            <td class="status-muted">${escapeHtml(formatShortTime(it.created_at))}</td>
            <td>${escapeHtml(it.user_name || String(it.user_id||'').slice(0,8))}</td>
            <td><code>${escapeHtml(String(it.key_name||'') || String(it.key_id||'').slice(0,8))}</code></td>
            <td title="${escapeHtml(t.title)}">${escapeHtml(t.text || String((it.agent_ids||[]).length))}</td>
            <td style="text-align:right;white-space:nowrap;">
              <button class="btn" data-view-id="${escapeHtml(it.id)}">Details</button>
              <button class="btn btn-primary" data-approve-id="${escapeHtml(it.id)}">Approve</button>
              <button class="btn" data-reject-id="${escapeHtml(it.id)}">Reject</button>
            </td>
          `;
          tbody.appendChild(tr);
        }

        tbody.querySelectorAll('button[data-view-id]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            const id = btn.getAttribute('data-view-id');
            const it = itemsById.get(String(id));
            if (!it) return;
            openSshKeyDeployApprovalModal(it);
          });
        });

        tbody.querySelectorAll('button[data-approve-id]').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.preventDefault();
            const id = btn.getAttribute('data-approve-id');
            if (!id) return;

            const it = itemsById.get(String(id));
            if (it) {
              const t = targetsLabel(it);
              const keyShort = (String(it.key_id||'')).slice(0,8);
              const keyLabel = (String(it.key_name||'').trim()) ? `${it.key_name} (${keyShort})` : keyShort;
              const ok = confirm(`Approve deployment request?\n\nRequested by: ${it.user_name || it.user_id}\nKey: ${keyLabel}\nTargets:\n${t.title}`);
              if (!ok) return;
            }

            const r2 = await fetch(`/sshkeys/admin/deploy-requests/${encodeURIComponent(id)}/approve`, { method: 'POST', credentials: 'include' });
            const raw = await r2.text();
            let data = null;
            try { data = raw ? JSON.parse(raw) : null; } catch { }
            if (!r2.ok) {
              const msg = (data && (data.detail || data.error)) ? (data.detail || data.error) : (raw || 'Approve failed');
              return showToast(msg, 'error');
            }
            if (data && String(data.status||'') === 'failed') {
              showToast(data.error || 'Request marked failed', 'error');
              maybeLoadSshKeyAdminQueue();
              return;
            }

            // If backend returned a job_id, poll and show outcome so admins get immediate feedback.
            const jobId = data && (data.job_id || data.jobId);
            if (jobId) {
              showToast('Approved (waiting for agent result)…', 'info', 4500);
              try {
                const waitFn = (window.phase3Ansible && typeof window.phase3Ansible.waitForJobDone === 'function')
                  ? window.phase3Ansible.waitForJobDone
                  : (window.pollJob ? window.pollJob : null);
                if (!waitFn) throw new Error('Job wait helper is not available');
                const res = await waitFn(String(jobId), 60000);
                const runSummary = (res.runs || []).map(r => `${r.agent_id}: ${r.status}${r.exit_code != null ? ` (exit ${r.exit_code})` : ''}${r.error ? ` — ${r.error}` : ''}`).join('\n');
                if (res.done && (res.runs || []).every(r => r.status === 'success')) {
                  showToast('Deployment completed successfully', 'success', 5000);
                } else if (res.done) {
                  showToast('Deployment finished with errors (open Details)', 'error', 6000);
                } else {
                  showToast('Deployment still running (check Jobs/logs)', 'info', 6000);
                }

                // Also open the details modal with targets + job outcome.
                const it2 = itemsById.get(String(id)) || it;
                if (it2) {
                  openSshKeyDeployApprovalModal({ ...it2, job: res, job_id: jobId, job_summary: runSummary });
                }
              } catch (err) {
                showToast(err.message || String(err), 'error', 6000);
              }
            } else {
              showToast('Approved', 'success');
            }

            maybeLoadSshKeyAdminQueue();
            loadAdminSshKeys();
          });
        });
        tbody.querySelectorAll('button[data-reject-id]').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.preventDefault();
            const id = btn.getAttribute('data-reject-id');
            if (!id) return;
            const r2 = await fetch(`/sshkeys/admin/deploy-requests/${encodeURIComponent(id)}/reject`, { method: 'POST', credentials: 'include' });
            const raw = await r2.text();
            let data = null;
            try { data = raw ? JSON.parse(raw) : null; } catch { }
            if (!r2.ok) {
              const msg = (data && (data.detail || data.error)) ? (data.detail || data.error) : (raw || 'Reject failed');
              return showToast(msg, 'error');
            }
            showToast('Rejected', 'success');
            maybeLoadSshKeyAdminQueue();
            loadAdminSshKeys();
          });
        });
      } catch (e) {
        const indicator = document.getElementById('sshkeys-approval-indicator');
        if (indicator) indicator.style.display = 'none';
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;" class="status-error">${escapeHtml(e.message)}</td></tr>`;
      }
    }

    function initAuditDetailModalControls() {
      const modal = document.getElementById('audit-detail-modal');
      const closeBtn = document.getElementById('audit-detail-modal-close');
      const copyBtn = document.getElementById('audit-detail-modal-copy');
      const outEl = document.getElementById('audit-detail-modal-output');
      if (!modal) return;

      const close = () => {
        modal.classList.remove('open');
        modal.setAttribute('aria-hidden', 'true');
        modal.hidden = true;
      };

      closeBtn?.addEventListener('click', (e) => { e.preventDefault(); close(); });
      modal.addEventListener('click', (e) => { if (e.target && e.target.id === 'audit-detail-modal') close(); });
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && modal.classList.contains('open')) close(); });

      copyBtn?.addEventListener('click', async (e) => {
        e.preventDefault();
        const text = outEl ? (outEl.value || '') : '';
        try {
          await navigator.clipboard.writeText(text);
          showToast('Copied', 'success');
        } catch {
          if (outEl) {
            outEl.focus();
            outEl.select();
          }
          showToast('Copy failed (clipboard blocked). Text selected—press Ctrl/Cmd+C.', 'error', 5000);
        }
      });
    }

    function initApprovalDetailModalControls() {
      const modal = document.getElementById('approval-detail-modal');
      const closeBtn = document.getElementById('approval-detail-modal-close');
      const copyBtn = document.getElementById('approval-detail-modal-copy');
      const outEl = document.getElementById('approval-detail-modal-output');
      if (!modal) return;

      const close = () => {
        modal.classList.remove('open');
        modal.setAttribute('aria-hidden', 'true');
        modal.hidden = true;
      };

      closeBtn?.addEventListener('click', (e) => { e.preventDefault(); close(); });
      modal.addEventListener('click', (e) => { if (e.target && e.target.id === 'approval-detail-modal') close(); });
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && modal.classList.contains('open')) close(); });

      copyBtn?.addEventListener('click', async (e) => {
        e.preventDefault();
        const text = outEl ? (outEl.value || '') : '';
        try {
          await navigator.clipboard.writeText(text);
          showToast('Copied', 'success');
        } catch {
          if (outEl) {
            outEl.focus();
            outEl.select();
          }
          showToast('Copy failed (clipboard blocked). Text selected—press Ctrl/Cmd+C.', 'error', 5000);
        }
      });
    }

    function initApprovalsFilterControls() {
      const ids = ['approvals-filter-action', 'approvals-filter-requester', 'approvals-filter-age', 'approvals-filter-mode', 'approvals-filter-sort'];
      ids.forEach((id) => {
        const el = document.getElementById(id);
        if (!el) return;
        const evt = (id === 'approvals-filter-action' || id === 'approvals-filter-requester') ? 'input' : 'change';
        el.addEventListener(evt, () => { loadAdminApprovals(false); });
      });

      const dedupeKind = document.getElementById('dedupe-filter-kind');
      const dedupeMinutes = document.getElementById('dedupe-filter-minutes');
      dedupeKind?.addEventListener('input', () => { loadAdminNotificationDedupe(false); });
      dedupeMinutes?.addEventListener('change', () => { loadAdminNotificationDedupe(false); });
    }

    function initHostActionControls() {
      const mod = window.phase3HostActions;
      if (mod && typeof mod.initHostActionControls === 'function') {
        return mod.initHostActionControls({ showServerInfo, showTerminal, showUsers, showServices, showPackages });
      }
    }

    function getSshUiCtx() {
      return {
        loadSshKeys,
        maybeLoadSshKeyAdminQueue,
        loadAdminSshKeys,
        loadAdminUsers,
        loadAdminApprovals,
        loadAdminNotificationDedupe,
        loadAdminAudit,
        setSshHostsPanelVisible,
        renderSshHostsList,
        getSshSelectedAgentIds,
        setSshSelectedAgentIds,
        getSshSelectedKeyId,
        loadSshKeyRequests,
        getAllHosts: () => allHosts,
      };
    }

    function initSshKeysControls() {
      const mod = window.phase3SshUi;
      if (mod && typeof mod.initSshKeysControls === 'function') {
        return mod.initSshKeysControls(getSshUiCtx());
      }
    }

// Load hosts on page load
    function safeInit(name, fn) {
      try { if (typeof fn === 'function') fn(); }
      catch (e) { console.error('[init failed]', name, e); }
    }

    // Load auth state first so header + MFA flow are not blocked by later init errors.
    loadAuthInfo().catch((e) => console.error('[loadAuthInfo failed]', e));

    safeInit('initHostFilters', initHostFilters);
    safeInit('initFleetOverviewControls', initFleetOverviewControls);
    safeInit('initHostsTableControls', initHostsTableControls);
    safeInit('initCronjobsControls', initCronjobsControls);
    safeInit('initSshKeysControls', initSshKeysControls);
    safeInit('initLoadTimeframeControls', initLoadTimeframeControls);
    safeInit('initPackagesSearch', initPackagesSearch);
    safeInit('initAdminPanel', initAdminPanel);
    safeInit('initOidcMapPreview', initOidcMapPreview);
    safeInit('initThemeToggle', initThemeToggle);
    safeInit('initSettingsMenu', initSettingsMenu);
    safeInit('initHostActionControls', initHostActionControls);
    safeInit('initAuditDetailModalControls', initAuditDetailModalControls);
    safeInit('initApprovalDetailModalControls', initApprovalDetailModalControls);
    safeInit('initApprovalsFilterControls', initApprovalsFilterControls);
    safeInit('bindDiskCardClick', () => {
      const diskCard = document.getElementById('disk-card');
      if (!diskCard) return;
      diskCard.addEventListener('click', (e) => {
        e.preventDefault();
        if (!currentAgentId) return;
        openDiskModal(currentAgentId);
      });
    });
    safeInit('bindDiskModalClose', () => {
      document.getElementById('disk-modal-close')?.addEventListener('click', (e) => {
        e.preventDefault();
        if (typeof closeDiskModal === 'function') closeDiskModal();
      });
      document.getElementById('disk-modal')?.addEventListener('click', (e) => {
        if (e.target && e.target.id === 'disk-modal' && typeof closeDiskModal === 'function') closeDiskModal();
      });
    });
    safeInit('initTerminalOnce', initTerminalOnce);
    safeInit('attachTerminalInputHandlerOnce', attachTerminalInputHandlerOnce);
    safeInit('initTerminalPendingCmdButton', () => {
      const btn = document.getElementById('terminal-run-pending-cmd');
      if (btn) btn.addEventListener('click', (e) => { e.preventDefault(); runPendingInteractivePackageCommand(); });
      updateTerminalPendingCmdButton();
    });
    safeInit('initAnsibleSection', initAnsibleSection);
    safeInit('initTimelineFilters', initTimelineFilters);

    safeInit('initCommonModalDismissHandlers', () => {
      const hostActionsMod = window.phase3HostActions;
      if (hostActionsMod && typeof hostActionsMod.initCommonModalDismissHandlers === 'function') {
        hostActionsMod.initCommonModalDismissHandlers({
          getCurrentMetricsAgentId: () => metricsLifecycleState.get('currentMetricsAgentId'),
          openDiskModal,
          closeDiskModal,
          closeServiceModal,
          closeUserModal,
        });
      }
    });
    const HOSTS_REFRESH_MS = 5000;
    let hostsRefreshTimer = null;

    function startHostRefresh() {
      if (hostsRefreshTimer) return;
      hostsRefreshTimer = setInterval(loadHosts, HOSTS_REFRESH_MS);
    }

    void loadHosts().catch((e) => {
      console.error('[loadHosts failed]', e);
      const hostsEl = document.getElementById('hosts');
      if (hostsEl) hostsEl.innerHTML = `<div class="error">Error loading hosts: ${escapeHtml(e?.message || String(e))}</div>`;
    });

    // Watchdog: never let hosts panel stay in perpetual loading state.
    setTimeout(() => {
      const hostsEl = document.getElementById('hosts');
      if (!hostsEl) return;
      const txt = (hostsEl.textContent || '').trim().toLowerCase();
      if (txt.includes('loading hosts')) {
        console.warn('[hosts-watchdog] still loading after 10s; forcing inline fallback');
        hostsEl.innerHTML = '<div class="error">Hosts view was stuck loading. Retrying…</div>';
        void loadHosts().catch((e) => {
          hostsEl.innerHTML = `<div class="error">Error loading hosts: ${escapeHtml(e?.message || String(e))}</div>`;
        });
      }
    }, 10000);

    void loadFleetOverview();
    void refreshApprovalsIndicator();
    startHostRefresh();
    setInterval(() => { void loadFleetOverview(); }, 15000);
    setInterval(() => { void refreshApprovalsIndicator(); }, 60000);
  </script>
</body>

</html>