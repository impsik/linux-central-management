<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Fleet Terminal</title>
  <link rel="stylesheet" href="/static/css/xterm.css" />
  <script src="/static/js/xterm.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; height: 100vh; background: #111827; color: #e5e7eb; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .bar { padding: 10px 12px; display:flex; gap:12px; align-items:center; border-bottom: 1px solid rgba(255,255,255,0.08); }
    .tag { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-weight:700; }
    .hint { color:#9ca3af; font-size: 12px; }
    #terminal { height: calc(100vh - 44px); }
  </style>
</head>
<body>
  <div class="bar">
    <div>Terminal:</div>
    <div class="tag" id="aid">-</div>
    <button id="run" style="margin-left:auto; padding:6px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.15); background:#111827; color:#e5e7eb; cursor:pointer;" disabled>Run</button>
    <button id="copy" style="padding:6px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.15); background:#111827; color:#e5e7eb; cursor:pointer;" disabled>Copy</button>
    <div class="hint" id="hint"></div>
  </div>
  <div id="terminal"></div>
  <script nonce="__CSP_NONCE__">
    const params = new URLSearchParams(location.search);
    const agentId = params.get('agent_id') || '';
    const cmd = params.get('cmd') || '';
    document.getElementById('aid').textContent = agentId || '-';
    document.getElementById('hint').textContent = cmd ? 'Command ready (click Run after login)' : '';

    const term = new Terminal({ convertEol: true });
    const termEl = document.getElementById("terminal");
    term.open(termEl);
    // Ensure focus + allow typing
    try { term.focus(); } catch { }
    termEl.addEventListener('mousedown', () => { try { term.focus(); } catch { } });
    termEl.addEventListener('touchstart', () => { try { term.focus(); } catch { } }, { passive: true });

    if (!agentId) {
      term.write("Missing agent_id\\r\\n");
      throw new Error("Missing agent_id");
    }

    const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
    const ws = new WebSocket(`${protocol}//${location.host}/ws/terminal/${encodeURIComponent(agentId)}`);
    ws.binaryType = "arraybuffer";

    // Send keystrokes to the backend
    term.onData(data => {
      if (ws && ws.readyState === 1) {
        ws.send(new TextEncoder().encode(data));
      }
    });

    function sendCommand() {
      if (!cmd) return;
      if (!ws || ws.readyState !== 1) return;
      ws.send(new TextEncoder().encode(cmd + "\n"));
      term.write(`\r\n[INFO] Sent: ${cmd}\r\n`);
      try { term.focus(); } catch { }
    }

    ws.onopen = () => {
      term.write(`Connected to ${agentId}\\r\\n`);
      try { term.focus(); } catch { }
    };
    const runBtn = document.getElementById('run');
    const copyBtn = document.getElementById('copy');
    if (cmd) {
      runBtn.disabled = false;
      copyBtn.disabled = false;
      runBtn.addEventListener('click', () => sendCommand());
      copyBtn.addEventListener('click', async () => {
        try {
          if (navigator.clipboard?.writeText) {
            await navigator.clipboard.writeText(cmd);
            term.write(`\r\n[INFO] Copied command to clipboard.\r\n`);
            return;
          }
        } catch { }
        term.write(`\r\n[INFO] Copy not available. Command:\r\n${cmd}\r\n`);
      });
    }

    ws.onmessage = (e) => {
      if (e.data instanceof ArrayBuffer) {
        term.write(new TextDecoder().decode(e.data));
      } else {
        term.write(e.data);
      }
    };
    ws.onerror = () => term.write("\\r\\n[ERROR] WebSocket error\\r\\n");
    ws.onclose = (e) => term.write(`\\r\\nConnection closed (code: ${e.code}, reason: ${e.reason || 'unknown'})\\r\\n`);
  </script>
</body>
</html>
