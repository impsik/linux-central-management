#!/usr/bin/env ansible-playbook
- name: Add user to server
  hosts: "{{ target_hosts | default('all') }}"
  remote_user: ubuntu
  become: true

  # Prefer non-interactive usage (CI / automation):
  #   ansible-playbook -i inventory.yml user_access.yml -e target_hosts=... -e username=... -e sudo=true -e generate_password=true
  # Prompts are only used if variables are not provided.
  vars_prompt:
    - name: username
      prompt: "Enter username: "
      private: false
    - name: target_hosts
      prompt: "Enter target hosts (FQDN, group, 'all', or space-separated hosts):"
      private: false
    - name: sudo
      prompt: "Grant sudo access? (yes/no)"
      private: false
    - name: generate_password
      prompt: "Generate a new strong password? (yes/no)"
      private: false

  pre_tasks:
    - name: Validate inputs
      ansible.builtin.assert:
        that:
          - username is defined
          - username | length > 0
        fail_msg: "Missing username (pass -e username=<name> or use the prompt)."

  tasks:
    - name: Generate a strong password for user {{ username }}
      ansible.builtin.set_fact:
        user_password_plain: "{{ lookup('password', '/dev/null length=20 chars=ascii_letters,digits') }}"
      when: generate_password | bool

    - name: Hash user password
      ansible.builtin.command: "openssl passwd -6 {{ user_password_plain }}"
      register: user_password_hash_cmd
      delegate_to: localhost
      changed_when: false
      no_log: true
      when: generate_password | bool

    - name: Store password hash
      ansible.builtin.set_fact:
        user_password_hash: "{{ user_password_hash_cmd.stdout }}"
      no_log: true
      when: generate_password | bool

    - name: "Create wheel user (RedHat): {{ username }}"
      ansible.builtin.user:
        name: "{{ username }}"
        groups: wheel
        append: true
        shell: /bin/bash
        password: "{{ user_password_hash | default(omit) }}"
      when:
        - ansible_os_family == 'RedHat'
        - sudo | bool
      register: user_create_redhat

    - name: "Create sudo user (Debian): {{ username }}"
      ansible.builtin.user:
        name: "{{ username }}"
        groups: sudo
        append: true
        shell: /bin/bash
        password: "{{ user_password_hash | default(omit) }}"
      when:
        - ansible_os_family == 'Debian'
        - sudo | bool
      register: user_create_debian

    - name: "Create user without sudo/wheel (RedHat): {{ username }}"
      ansible.builtin.user:
        name: "{{ username }}"
        shell: /bin/bash
        password: "{{ user_password_hash | default(omit) }}"
      when:
        - ansible_os_family == 'RedHat'
        - not (sudo | bool)
      register: user_create_redhat_nosudo

    - name: "Create user without sudo/wheel (Debian): {{ username }}"
      ansible.builtin.user:
        name: "{{ username }}"
        shell: /bin/bash
        password: "{{ user_password_hash | default(omit) }}"
      when:
        - ansible_os_family == 'Debian'
        - not (sudo | bool)
      register: user_create_debian_nosudo

    - name: Show generated password (only when user is created)
      ansible.builtin.debug:
        msg: "User {{ username }} password: {{ user_password_plain }}"
      when:
        - generate_password | bool
        - (user_create_redhat is changed) or (user_create_debian is changed) or (user_create_redhat_nosudo is changed) or (user_create_debian_nosudo is changed)

    - name: Grant passwordless sudo and validate sudoers
      ansible.builtin.lineinfile:
        backup: true
        path: /etc/sudoers
        state: present
        line: "{{ username }} ALL=(ALL) NOPASSWD: ALL"
        validate: /usr/sbin/visudo -cf %s
      when: sudo | bool
